<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 6.2 Achievement System Test - LobeLabyrinth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #4a5568;
            margin-bottom: 20px;
            text-align: center;
        }

        .test-section {
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }

        .test-section h2 {
            color: #2d3748;
            margin-bottom: 15px;
            border-bottom: 2px solid #9f7aea;
            padding-bottom: 5px;
        }

        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .test-button {
            background: #9f7aea;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .test-button:hover {
            background: #805ad5;
            transform: translateY(-1px);
        }

        .test-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .test-output {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .achievement-demo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .stats-display {
            background: #edf2f7;
            border-radius: 6px;
            padding: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .progress-bar {
            background: #e2e8f0;
            border-radius: 10px;
            height: 8px;
            margin: 5px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #9f7aea, #b794f6);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .success { color: #22543d; background: #c6f6d5; }
        .error { color: #742a2a; background: #fed7d7; }
        .warning { color: #744210; background: #faf089; }
        .info { color: #2a4365; background: #bee3f8; }

        .test-console {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 6px;
            overflow-y: auto;
            z-index: 1000;
        }

        .hidden { display: none; }

        /* Import achievement styles from main game */
        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateY(-100%);
            opacity: 0;
            transition: all 0.3s ease-in-out;
            pointer-events: none;
        }

        .achievement-notification.show {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .achievement-unlock-animation {
            background: linear-gradient(135deg, #fef5e7, #fed7aa);
            border: 2px solid #f6ad55;
            border-radius: 12px;
            padding: 15px;
            max-width: 350px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: achievementPulse 0.6s ease-out;
        }

        @keyframes achievementPulse {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        .achievement-icon {
            font-size: 2.5em;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .achievement-details {
            flex: 1;
        }

        .achievement-title {
            font-weight: bold;
            color: #7b341e;
            font-size: 0.9em;
            margin-bottom: 2px;
        }

        .achievement-name {
            font-weight: bold;
            color: #2d3748;
            font-size: 1.1em;
            margin-bottom: 4px;
        }

        .achievement-description {
            color: #4a5568;
            font-size: 0.85em;
            margin-bottom: 4px;
        }

        .achievement-points {
            color: #9f7aea;
            font-weight: bold;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ Achievement System Test Suite - Phase 6.2</h1>
        
        <!-- Initialization Test -->
        <div class="test-section">
            <h2>1. System Initialization</h2>
            <div class="test-controls">
                <button class="test-button" onclick="testInitialization()">Initialize Achievement System</button>
                <button class="test-button" onclick="testDataLoading()">Test Data Loading</button>
                <button class="test-button" onclick="testEventSystem()">Test Event System</button>
                <button class="test-button" onclick="resetSystem()">Reset System</button>
            </div>
            <div id="init-output" class="test-output"></div>
        </div>

        <!-- Achievement Tracking Test -->
        <div class="test-section">
            <h2>2. Achievement Tracking</h2>
            <div class="test-controls">
                <button class="test-button" onclick="simulateFirstSteps()">Simulate First Correct Answer</button>
                <button class="test-button" onclick="simulateExploration()">Simulate Room Exploration</button>
                <button class="test-button" onclick="simulateQuickAnswers()">Simulate Quick Answers</button>
                <button class="test-button" onclick="simulateConsecutiveCorrect()">Simulate Perfect Streak</button>
            </div>
            <div id="tracking-output" class="test-output"></div>
        </div>

        <!-- Progress Monitoring Test -->
        <div class="test-section">
            <h2>3. Progress Monitoring</h2>
            <div class="achievement-demo">
                <div>
                    <div class="test-controls">
                        <button class="test-button" onclick="updateProgress()">Update Progress</button>
                        <button class="test-button" onclick="showAllProgress()">Show All Progress</button>
                        <button class="test-button" onclick="testProgressSaving()">Test Save/Load</button>
                    </div>
                </div>
                <div class="stats-display">
                    <h3>Achievement Stats</h3>
                    <div id="achievement-stats">
                        <div class="stat-item">
                            <span>Total Achievements:</span>
                            <span id="total-achievements">0</span>
                        </div>
                        <div class="stat-item">
                            <span>Unlocked:</span>
                            <span id="unlocked-achievements">0</span>
                        </div>
                        <div class="stat-item">
                            <span>Completion:</span>
                            <span id="completion-percentage">0%</span>
                        </div>
                        <div class="stat-item">
                            <span>Total Points:</span>
                            <span id="total-points">0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="progress-output" class="test-output"></div>
        </div>

        <!-- Notification System Test -->
        <div class="test-section">
            <h2>4. Notification System</h2>
            <div class="test-controls">
                <button class="test-button" onclick="testNotificationDisplay()">Test Notification Display</button>
                <button class="test-button" onclick="testNotificationQueue()">Test Notification Queue</button>
                <button class="test-button" onclick="testNotificationAnimation()">Test Animation</button>
                <button class="test-button" onclick="triggerRandomAchievement()">Trigger Random Achievement</button>
            </div>
            <div id="notification-output" class="test-output"></div>
        </div>

        <!-- Edge Cases Test -->
        <div class="test-section">
            <h2>5. Edge Cases & Validation</h2>
            <div class="test-controls">
                <button class="test-button" onclick="testDuplicateUnlocks()">Test Duplicate Unlocks</button>
                <button class="test-button" onclick="testInvalidConditions()">Test Invalid Conditions</button>
                <button class="test-button" onclick="testStorageErrors()">Test Storage Errors</button>
                <button class="test-button" onclick="testPerformance()">Test Performance</button>
            </div>
            <div id="validation-output" class="test-output"></div>
        </div>

        <!-- Integration Test -->
        <div class="test-section">
            <h2>6. Game Integration</h2>
            <div class="test-controls">
                <button class="test-button" onclick="simulateGameFlow()">Simulate Complete Game Flow</button>
                <button class="test-button" onclick="testUIIntegration()">Test UI Integration</button>
                <button class="test-button" onclick="testGameStateSync()">Test GameState Sync</button>
                <button class="test-button" onclick="generateTestReport()">Generate Test Report</button>
            </div>
            <div id="integration-output" class="test-output"></div>
        </div>
    </div>

    <!-- Test Console -->
    <div id="test-console" class="test-console">
        <div>Achievement System Test Console</div>
        <div>Ready for testing...</div>
    </div>

    <!-- Achievement Notification Area -->
    <div id="achievement-notification" class="achievement-notification">
        <!-- Will be populated by notifications -->
    </div>

    <!-- Load required modules for testing -->
    <script src="src/dataLoader.js"></script>
    <script src="src/gameState.js"></script>
    <script src="src/achievementManager.js"></script>

    <script>
        // Test Environment Setup
        let testDataLoader;
        let testGameState;
        let testAchievementManager;
        let testResults = [];
        let testStartTime;

        // Console logging helper
        function logToConsole(message, type = 'info') {
            const console = document.getElementById('test-console');
            const timestamp = new Date().toLocaleTimeString();
            const logLine = document.createElement('div');
            logLine.textContent = `[${timestamp}] ${message}`;
            logLine.className = type;
            console.appendChild(logLine);
            console.scrollTop = console.scrollHeight;
        }

        function logToOutput(outputId, message, type = 'info') {
            const output = document.getElementById(outputId);
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        // Test Result Tracking
        function recordTestResult(testName, passed, details = '') {
            testResults.push({
                name: testName,
                passed,
                details,
                timestamp: new Date()
            });
            
            const status = passed ? '‚úÖ PASS' : '‚ùå FAIL';
            logToConsole(`${testName}: ${status} ${details}`);
        }

        // 1. System Initialization Tests
        async function testInitialization() {
            logToOutput('init-output', 'Starting initialization test...', 'info');
            
            try {
                testStartTime = Date.now();
                
                // Initialize DataLoader
                testDataLoader = new DataLoader();
                await testDataLoader.loadGameData();
                logToOutput('init-output', '‚úÖ DataLoader initialized', 'success');
                
                // Initialize GameState
                testGameState = new GameState(testDataLoader);
                logToOutput('init-output', '‚úÖ GameState initialized', 'success');
                
                // Initialize AchievementManager
                testAchievementManager = new AchievementManager(testDataLoader, testGameState);
                await testAchievementManager.initialize();
                logToOutput('init-output', '‚úÖ AchievementManager initialized', 'success');
                
                // Test achievement loading
                const achievements = testAchievementManager.getAllAchievements();
                logToOutput('init-output', `‚úÖ Loaded ${achievements.length} achievements`, 'success');
                
                recordTestResult('System Initialization', true, `${achievements.length} achievements loaded`);
                updateStatsDisplay();
                
            } catch (error) {
                logToOutput('init-output', `‚ùå Initialization failed: ${error.message}`, 'error');
                recordTestResult('System Initialization', false, error.message);
            }
        }

        async function testDataLoading() {
            if (!testAchievementManager) {
                logToOutput('init-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            try {
                const achievements = testAchievementManager.getAllAchievements();
                const stats = testAchievementManager.getAchievementStats();
                
                logToOutput('init-output', `Data validation:`, 'info');
                logToOutput('init-output', `- Total achievements: ${stats.total}`, 'info');
                logToOutput('init-output', `- Categories: ${Object.keys(stats.categories).join(', ')}`, 'info');
                logToOutput('init-output', `- Rarities: ${[...new Set(achievements.map(a => a.rarity))].join(', ')}`, 'info');
                
                // Validate achievement structure
                const requiredFields = ['id', 'name', 'description', 'icon', 'condition', 'points', 'rarity'];
                let validationErrors = [];
                
                achievements.forEach(achievement => {
                    requiredFields.forEach(field => {
                        if (!achievement.hasOwnProperty(field)) {
                            validationErrors.push(`Achievement ${achievement.id} missing field: ${field}`);
                        }
                    });
                });
                
                if (validationErrors.length === 0) {
                    logToOutput('init-output', '‚úÖ All achievements have valid structure', 'success');
                    recordTestResult('Data Validation', true, 'All achievements valid');
                } else {
                    logToOutput('init-output', `‚ùå Validation errors:\n${validationErrors.join('\n')}`, 'error');
                    recordTestResult('Data Validation', false, `${validationErrors.length} errors`);
                }
                
            } catch (error) {
                logToOutput('init-output', `‚ùå Data loading test failed: ${error.message}`, 'error');
                recordTestResult('Data Loading', false, error.message);
            }
        }

        async function testEventSystem() {
            if (!testAchievementManager) {
                logToOutput('init-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            try {
                let eventReceived = false;
                
                // Set up event listener
                testAchievementManager.addEventListener('achievementUnlocked', (event) => {
                    eventReceived = true;
                    logToOutput('init-output', `‚úÖ Event received: ${event.detail.achievement.name}`, 'success');
                });
                
                // Manually trigger an achievement for testing
                const firstAchievement = testAchievementManager.achievements.get('first_steps');
                if (firstAchievement) {
                    testAchievementManager.unlockAchievement('first_steps');
                    
                    setTimeout(() => {
                        if (eventReceived) {
                            recordTestResult('Event System', true, 'Events working correctly');
                        } else {
                            recordTestResult('Event System', false, 'Event not received');
                        }
                    }, 100);
                } else {
                    logToOutput('init-output', '‚ùå Could not find test achievement', 'error');
                    recordTestResult('Event System', false, 'Test achievement not found');
                }
                
            } catch (error) {
                logToOutput('init-output', `‚ùå Event system test failed: ${error.message}`, 'error');
                recordTestResult('Event System', false, error.message);
            }
        }

        function resetSystem() {
            if (testAchievementManager) {
                testAchievementManager.resetAchievements();
                logToOutput('init-output', 'üîÑ Achievement system reset', 'warning');
                updateStatsDisplay();
                recordTestResult('System Reset', true, 'System reset successfully');
            }
        }

        // 2. Achievement Tracking Tests
        function simulateFirstSteps() {
            if (!testAchievementManager) {
                logToOutput('tracking-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            // Simulate a correct answer
            testAchievementManager.handleQuestionAnswered({
                isCorrect: true,
                timeElapsed: 8000,
                pointsEarned: 100
            });
            
            logToOutput('tracking-output', '‚úÖ Simulated first correct answer', 'success');
            updateStatsDisplay();
            recordTestResult('First Steps Achievement', true, 'Simulated correctly');
        }

        function simulateExploration() {
            if (!testAchievementManager) {
                logToOutput('tracking-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            // Simulate visiting multiple rooms
            const rooms = ['entrance', 'library', 'laboratory', 'treasury'];
            rooms.forEach(room => {
                testAchievementManager.handleRoomChanged({ to: room });
            });
            
            logToOutput('tracking-output', `‚úÖ Simulated exploration of ${rooms.length} rooms`, 'success');
            updateStatsDisplay();
            recordTestResult('Exploration Achievement', true, `${rooms.length} rooms visited`);
        }

        function simulateQuickAnswers() {
            if (!testAchievementManager) {
                logToOutput('tracking-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            // Simulate 5 quick correct answers
            for (let i = 0; i < 5; i++) {
                testAchievementManager.handleQuestionAnswered({
                    isCorrect: true,
                    timeElapsed: 7000 + (i * 500), // 7-9 seconds
                    pointsEarned: 100
                });
            }
            
            logToOutput('tracking-output', '‚úÖ Simulated 5 quick correct answers', 'success');
            updateStatsDisplay();
            recordTestResult('Quick Thinking Achievement', true, '5 quick answers simulated');
        }

        function simulateConsecutiveCorrect() {
            if (!testAchievementManager) {
                logToOutput('tracking-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            // Simulate 10 consecutive correct answers
            for (let i = 0; i < 10; i++) {
                testAchievementManager.handleQuestionAnswered({
                    isCorrect: true,
                    timeElapsed: 12000,
                    pointsEarned: 100
                });
            }
            
            logToOutput('tracking-output', '‚úÖ Simulated 10 consecutive correct answers', 'success');
            updateStatsDisplay();
            recordTestResult('Perfect Streak Achievement', true, '10 consecutive correct answers');
        }

        // 3. Progress Monitoring Tests
        function updateProgress() {
            if (!testAchievementManager) {
                logToOutput('progress-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            const achievements = testAchievementManager.getAllAchievements();
            let progressReport = 'Current Achievement Progress:\n\n';
            
            achievements.forEach(achievement => {
                const progress = achievement.progressPercentage.toFixed(1);
                const status = achievement.unlocked ? 'üèÜ UNLOCKED' : `üìà ${progress}%`;
                progressReport += `${achievement.name}: ${status}\n`;
            });
            
            logToOutput('progress-output', progressReport, 'info');
            updateStatsDisplay();
        }

        function showAllProgress() {
            if (!testAchievementManager) {
                logToOutput('progress-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            const stats = testAchievementManager.getAchievementStats();
            const categoryStats = stats.categories;
            
            let report = 'Achievement Progress by Category:\n\n';
            
            Object.keys(categoryStats).forEach(category => {
                const catStats = categoryStats[category];
                report += `${category.toUpperCase()}: ${catStats.unlocked}/${catStats.total} (${catStats.percentage.toFixed(1)}%)\n`;
            });
            
            report += `\nTotal Points: ${stats.totalPoints}\n`;
            report += `Overall Completion: ${stats.percentage}%`;
            
            logToOutput('progress-output', report, 'info');
        }

        function testProgressSaving() {
            if (!testAchievementManager) {
                logToOutput('progress-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            try {
                // Save current progress
                testAchievementManager.saveAchievementProgress();
                logToOutput('progress-output', '‚úÖ Progress saved to localStorage', 'success');
                
                // Try to load it back
                testAchievementManager.loadAchievementProgress();
                logToOutput('progress-output', '‚úÖ Progress loaded from localStorage', 'success');
                
                recordTestResult('Progress Persistence', true, 'Save/load working correctly');
            } catch (error) {
                logToOutput('progress-output', `‚ùå Progress save/load failed: ${error.message}`, 'error');
                recordTestResult('Progress Persistence', false, error.message);
            }
        }

        // 4. Notification System Tests
        function testNotificationDisplay() {
            if (!testAchievementManager) {
                logToOutput('notification-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            // Create a test achievement unlock
            const testAchievement = {
                achievement: {
                    id: 'test',
                    name: 'Test Achievement',
                    description: 'This is a test achievement notification',
                    icon: 'üß™',
                    points: 50,
                    rarity: 'common'
                },
                totalPoints: 50,
                unlockedCount: 1
            };
            
            showTestNotification(testAchievement);
            logToOutput('notification-output', '‚úÖ Test notification displayed', 'success');
            recordTestResult('Notification Display', true, 'Test notification shown');
        }

        function testNotificationQueue() {
            if (!testAchievementManager) {
                logToOutput('notification-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            // Queue multiple notifications
            const testAchievements = [
                { name: 'First Test', icon: '1Ô∏è‚É£', points: 25, rarity: 'common' },
                { name: 'Second Test', icon: '2Ô∏è‚É£', points: 50, rarity: 'uncommon' },
                { name: 'Third Test', icon: '3Ô∏è‚É£', points: 100, rarity: 'rare' }
            ];
            
            testAchievements.forEach((ach, index) => {
                setTimeout(() => {
                    showTestNotification({
                        achievement: {
                            id: `test_${index}`,
                            description: `Test notification ${index + 1}`,
                            ...ach
                        },
                        totalPoints: (index + 1) * 25,
                        unlockedCount: index + 1
                    });
                }, index * 1000);
            });
            
            logToOutput('notification-output', '‚úÖ Notification queue test started (3 notifications)', 'success');
            recordTestResult('Notification Queue', true, '3 notifications queued');
        }

        function testNotificationAnimation() {
            // This tests the CSS animation system
            const notification = document.getElementById('achievement-notification');
            
            notification.innerHTML = `
                <div class="achievement-unlock-animation">
                    <div class="achievement-icon">üé¨</div>
                    <div class="achievement-details">
                        <div class="achievement-title">Animation Test</div>
                        <div class="achievement-name">Smooth Animations</div>
                        <div class="achievement-description">Testing CSS animations and transitions</div>
                        <div class="achievement-points">+75 points</div>
                    </div>
                </div>
            `;
            
            notification.className = 'achievement-notification show';
            
            setTimeout(() => {
                notification.className = 'achievement-notification';
            }, 3000);
            
            logToOutput('notification-output', '‚úÖ Animation test completed', 'success');
            recordTestResult('Notification Animation', true, 'CSS animations working');
        }

        function triggerRandomAchievement() {
            if (!testAchievementManager) {
                logToOutput('notification-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            const achievements = testAchievementManager.getAllAchievements();
            const lockedAchievements = achievements.filter(a => !a.unlocked);
            
            if (lockedAchievements.length === 0) {
                logToOutput('notification-output', '‚ö†Ô∏è All achievements already unlocked', 'warning');
                return;
            }
            
            const randomAchievement = lockedAchievements[Math.floor(Math.random() * lockedAchievements.length)];
            testAchievementManager.unlockAchievement(randomAchievement.id);
            
            logToOutput('notification-output', `üé≤ Randomly unlocked: ${randomAchievement.name}`, 'success');
            updateStatsDisplay();
        }

        // 5. Edge Cases & Validation Tests
        function testDuplicateUnlocks() {
            if (!testAchievementManager) {
                logToOutput('validation-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            try {
                // Try to unlock the same achievement multiple times
                const achievementId = 'first_steps';
                const pointsBefore = testAchievementManager.totalAchievementPoints;
                
                testAchievementManager.unlockAchievement(achievementId);
                const pointsAfterFirst = testAchievementManager.totalAchievementPoints;
                
                testAchievementManager.unlockAchievement(achievementId);
                const pointsAfterSecond = testAchievementManager.totalAchievementPoints;
                
                if (pointsAfterFirst === pointsAfterSecond) {
                    logToOutput('validation-output', '‚úÖ Duplicate unlock prevention working', 'success');
                    recordTestResult('Duplicate Prevention', true, 'No duplicate points awarded');
                } else {
                    logToOutput('validation-output', '‚ùå Duplicate unlock allowed', 'error');
                    recordTestResult('Duplicate Prevention', false, 'Duplicate points awarded');
                }
                
            } catch (error) {
                logToOutput('validation-output', `‚ùå Duplicate unlock test failed: ${error.message}`, 'error');
                recordTestResult('Duplicate Prevention', false, error.message);
            }
        }

        function testInvalidConditions() {
            if (!testAchievementManager) {
                logToOutput('validation-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            try {
                // Test with invalid/undefined achievement
                const result = testAchievementManager.checkAchievementCondition({ condition: { type: 'invalid_type' } });
                
                if (result === false) {
                    logToOutput('validation-output', '‚úÖ Invalid conditions handled gracefully', 'success');
                    recordTestResult('Invalid Condition Handling', true, 'Returns false for invalid conditions');
                } else {
                    logToOutput('validation-output', '‚ùå Invalid conditions not handled properly', 'error');
                    recordTestResult('Invalid Condition Handling', false, 'Does not handle invalid conditions');
                }
                
            } catch (error) {
                logToOutput('validation-output', `‚ö†Ô∏è Exception thrown for invalid conditions: ${error.message}`, 'warning');
                recordTestResult('Invalid Condition Handling', true, 'Throws appropriate exception');
            }
        }

        function testStorageErrors() {
            if (!testAchievementManager) {
                logToOutput('validation-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            try {
                // Temporarily break localStorage to test error handling
                const originalSetItem = localStorage.setItem;
                localStorage.setItem = () => { throw new Error('Storage quota exceeded'); };
                
                // Try to save - should handle error gracefully
                testAchievementManager.saveAchievementProgress();
                
                // Restore localStorage
                localStorage.setItem = originalSetItem;
                
                logToOutput('validation-output', '‚úÖ Storage errors handled gracefully', 'success');
                recordTestResult('Storage Error Handling', true, 'Graceful error handling');
                
            } catch (error) {
                logToOutput('validation-output', `‚ùå Storage error handling failed: ${error.message}`, 'error');
                recordTestResult('Storage Error Handling', false, error.message);
            }
        }

        function testPerformance() {
            if (!testAchievementManager) {
                logToOutput('validation-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            const startTime = performance.now();
            
            // Simulate rapid achievement checking
            for (let i = 0; i < 1000; i++) {
                testAchievementManager.checkAchievementUnlocks();
            }
            
            const endTime = performance.now();
            const duration = endTime - startTime;
            
            logToOutput('validation-output', `Performance test: 1000 checks took ${duration.toFixed(2)}ms`, 'info');
            
            if (duration < 100) {
                logToOutput('validation-output', '‚úÖ Performance test passed (< 100ms)', 'success');
                recordTestResult('Performance Test', true, `${duration.toFixed(2)}ms for 1000 checks`);
            } else {
                logToOutput('validation-output', '‚ö†Ô∏è Performance test slow (> 100ms)', 'warning');
                recordTestResult('Performance Test', false, `${duration.toFixed(2)}ms is too slow`);
            }
        }

        // 6. Integration Tests
        function simulateGameFlow() {
            if (!testAchievementManager) {
                logToOutput('integration-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            logToOutput('integration-output', 'üéÆ Starting complete game flow simulation...', 'info');
            
            // Reset first
            testAchievementManager.resetAchievements();
            
            // Simulate a complete game session
            setTimeout(() => {
                // First correct answer
                testAchievementManager.handleQuestionAnswered({ isCorrect: true, timeElapsed: 8000, pointsEarned: 100 });
                logToOutput('integration-output', '1. First correct answer', 'info');
            }, 500);
            
            setTimeout(() => {
                // Room exploration
                ['library', 'laboratory', 'treasury'].forEach(room => {
                    testAchievementManager.handleRoomChanged({ to: room });
                });
                logToOutput('integration-output', '2. Explored multiple rooms', 'info');
            }, 1000);
            
            setTimeout(() => {
                // Quick answers sequence
                for (let i = 0; i < 5; i++) {
                    testAchievementManager.handleQuestionAnswered({ isCorrect: true, timeElapsed: 8000, pointsEarned: 100 });
                }
                logToOutput('integration-output', '3. Answered questions quickly', 'info');
            }, 1500);
            
            setTimeout(() => {
                // Perfect streak
                for (let i = 0; i < 10; i++) {
                    testAchievementManager.handleQuestionAnswered({ isCorrect: true, timeElapsed: 12000, pointsEarned: 100 });
                }
                logToOutput('integration-output', '4. Perfect answer streak', 'info');
            }, 2000);
            
            setTimeout(() => {
                // Game completion
                testAchievementManager.handleGameCompleted({ finalScore: 2500 });
                logToOutput('integration-output', '5. Game completed', 'info');
                
                const stats = testAchievementManager.getAchievementStats();
                logToOutput('integration-output', `‚úÖ Game flow complete! Unlocked ${stats.unlocked}/${stats.total} achievements`, 'success');
                recordTestResult('Complete Game Flow', true, `${stats.unlocked} achievements unlocked`);
                updateStatsDisplay();
            }, 2500);
        }

        function testUIIntegration() {
            // Test if UI elements exist and are accessible
            const elements = [
                'achievement-notification',
                'test-console'
            ];
            
            let missingElements = [];
            elements.forEach(id => {
                if (!document.getElementById(id)) {
                    missingElements.push(id);
                }
            });
            
            if (missingElements.length === 0) {
                logToOutput('integration-output', '‚úÖ All UI elements present', 'success');
                recordTestResult('UI Integration', true, 'All elements found');
            } else {
                logToOutput('integration-output', `‚ùå Missing UI elements: ${missingElements.join(', ')}`, 'error');
                recordTestResult('UI Integration', false, `Missing: ${missingElements.join(', ')}`);
            }
        }

        function testGameStateSync() {
            if (!testAchievementManager || !testGameState) {
                logToOutput('integration-output', '‚ùå System not initialized', 'error');
                return;
            }
            
            try {
                // Test if achievement manager properly reads game state
                const gameSnapshot = testGameState.getStateSnapshot();
                const achievementDebug = testAchievementManager.getDebugInfo();
                
                logToOutput('integration-output', 'GameState sync test:', 'info');
                logToOutput('integration-output', `- Game score: ${gameSnapshot.score}`, 'info');
                logToOutput('integration-output', `- Achievement session stats: ${JSON.stringify(achievementDebug.sessionStats, null, 2)}`, 'info');
                
                recordTestResult('GameState Sync', true, 'Sync working correctly');
            } catch (error) {
                logToOutput('integration-output', `‚ùå GameState sync failed: ${error.message}`, 'error');
                recordTestResult('GameState Sync', false, error.message);
            }
        }

        function generateTestReport() {
            const totalTests = testResults.length;
            const passedTests = testResults.filter(test => test.passed).length;
            const failedTests = totalTests - passedTests;
            const successRate = totalTests > 0 ? (passedTests / totalTests * 100).toFixed(1) : 0;
            
            let report = `
ACHIEVEMENT SYSTEM TEST REPORT
==============================
Generated: ${new Date().toLocaleString()}
Test Duration: ${testStartTime ? ((Date.now() - testStartTime) / 1000).toFixed(1) + 's' : 'N/A'}

SUMMARY
-------
Total Tests: ${totalTests}
Passed: ${passedTests} ‚úÖ
Failed: ${failedTests} ‚ùå
Success Rate: ${successRate}%

DETAILED RESULTS
---------------
`;
            
            testResults.forEach(test => {
                const status = test.passed ? '‚úÖ PASS' : '‚ùå FAIL';
                report += `${status} ${test.name}\n`;
                if (test.details) report += `    Details: ${test.details}\n`;
            });
            
            if (testAchievementManager) {
                const stats = testAchievementManager.getAchievementStats();
                report += `
ACHIEVEMENT STATS
----------------
Total Achievements: ${stats.total}
Unlocked: ${stats.unlocked}
Completion: ${stats.percentage}%
Total Points: ${stats.totalPoints}
`;
            }
            
            logToOutput('integration-output', report, 'info');
            
            // Also log to console for copying
            console.log(report);
            
            recordTestResult('Test Report Generated', true, `${successRate}% success rate`);
        }

        // Helper Functions
        function updateStatsDisplay() {
            if (!testAchievementManager) return;
            
            const stats = testAchievementManager.getAchievementStats();
            
            document.getElementById('total-achievements').textContent = stats.total;
            document.getElementById('unlocked-achievements').textContent = stats.unlocked;
            document.getElementById('completion-percentage').textContent = stats.percentage.toFixed(1) + '%';
            document.getElementById('total-points').textContent = stats.totalPoints;
        }

        function showTestNotification(achievementData) {
            const notification = document.getElementById('achievement-notification');
            const { achievement } = achievementData;
            
            notification.innerHTML = `
                <div class="achievement-unlock-animation">
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-details">
                        <div class="achievement-title">Achievement Unlocked!</div>
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-description">${achievement.description}</div>
                        <div class="achievement-points">+${achievement.points} points</div>
                    </div>
                </div>
            `;
            
            notification.className = 'achievement-notification show';
            
            setTimeout(() => {
                notification.className = 'achievement-notification';
            }, 4000);
        }

        // Initialize test environment when page loads
        document.addEventListener('DOMContentLoaded', () => {
            logToConsole('Achievement System Test Suite loaded');
            logToConsole('Click "Initialize Achievement System" to begin testing');
        });
    </script>
</body>
</html>