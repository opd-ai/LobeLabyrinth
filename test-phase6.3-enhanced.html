<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Phase 6.3 Enhanced - Performance Statistics & Replay</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .test-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }
        
        button.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        button.success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .status.success { background: rgba(46, 204, 113, 0.2); border-left: 4px solid #2ecc71; }
        .status.error { background: rgba(231, 76, 60, 0.2); border-left: 4px solid #e74c3c; }
        .status.info { background: rgba(52, 152, 219, 0.2); border-left: 4px solid #3498db; }
        
        .game-container {
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            min-height: 400px;
        }
        
        .test-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4facfe;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .feature-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }
        
        .feature-item h4 {
            margin: 0 0 10px 0;
            color: #4facfe;
        }
        
        .feature-item p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .enhanced-info {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🚀 Phase 6.3 Enhanced: Performance Statistics & Replay</h1>
            <p>Testing enhanced performance analytics, detailed statistics, and replay functionality</p>
        </div>
        
        <div class="enhanced-info">
            <h3>✨ Enhanced Features</h3>
            <ul>
                <li><strong>📊 Detailed Performance Analytics:</strong> Comprehensive statistics with bonus breakdowns</li>
                <li><strong>🏆 Performance Grading:</strong> S/A/B/C/D/F grade system with animated displays</li>
                <li><strong>🎯 Enhanced Achievement Integration:</strong> Achievement points and visual displays</li>
                <li><strong>📱 Native Sharing:</strong> Web Share API with clipboard fallback</li>
                <li><strong>🔄 Replay Functionality:</strong> Smooth game reset with preservation of achievements</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>🎮 Enhanced Game Test Controls</h3>
            <div class="test-controls">
                <button onclick="initializeEnhancedGame()">🚀 Initialize Enhanced Game</button>
                <button onclick="simulateVariedPerformance()" class="success">⚡ Simulate Varied Performance</button>
                <button onclick="simulatePerfectGame()" class="success">🌟 Simulate Perfect Game</button>
                <button onclick="simulateSpeedRun()" class="success">🏃‍♂️ Simulate Speed Run</button>
                <button onclick="triggerEnhancedVictory()" class="success">🏆 Show Enhanced Victory Screen</button>
                <button onclick="testReplayFunctionality()">🔄 Test Replay Functionality</button>
                <button onclick="testSharingFeature()">📤 Test Sharing Feature</button>
                <button onclick="resetEnhancedGame()" class="danger">🔄 Reset Enhanced Game</button>
            </div>
        </div>

        <div class="test-section">
            <h3>📊 Enhanced Performance Analytics</h3>
            <div class="feature-list">
                <div class="feature-item">
                    <h4>📈 Detailed Score Breakdown</h4>
                    <p>Base score, completion bonus (+500), exploration bonus (+10/room), perfect game bonus (+1000), speed run bonus (+750)</p>
                </div>
                <div class="feature-item">
                    <h4>⏱️ Comprehensive Timing Analysis</h4>
                    <p>Total play time, average answer time, formatted time displays, speed run detection</p>
                </div>
                <div class="feature-item">
                    <h4>🎯 Performance Grading System</h4>
                    <p>S/A/B/C/D/F grades based on accuracy (50%), exploration (30%), completion (20%)</p>
                </div>
                <div class="feature-item">
                    <h4>🏅 Achievement Integration</h4>
                    <p>Achievement points calculation, visual achievement display, progress tracking</p>
                </div>
                <div class="feature-item">
                    <h4>📱 Native Sharing</h4>
                    <p>Web Share API for mobile, clipboard fallback for desktop, formatted share text with emojis</p>
                </div>
                <div class="feature-item">
                    <h4>🔄 Smart Replay System</h4>
                    <p>Clean game reset, achievement preservation, smooth transitions, user feedback</p>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>📊 Current Enhanced Statistics</h3>
            <div class="test-stats" id="enhancedStats">
                <div class="stat-card">
                    <div class="stat-value" id="enhancedFinalScore">0</div>
                    <div class="stat-label">Final Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="enhancedPerformanceGrade">-</div>
                    <div class="stat-label">Performance Grade</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="enhancedPlayTime">0s</div>
                    <div class="stat-label">Play Time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="enhancedAccuracy">0%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="enhancedExploration">0%</div>
                    <div class="stat-label">Exploration</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="enhancedAchievements">0</div>
                    <div class="stat-label">Achievements</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>🖥️ Enhanced Game Interface</h3>
            <div class="game-container" id="enhancedGameContainer">
                <!-- Enhanced game interface will be loaded here -->
            </div>
        </div>

        <div class="test-section">
            <h3>📋 Enhanced Test Results</h3>
            <div id="enhancedTestResults"></div>
        </div>

        <div class="test-section">
            <h3>📊 Detailed Statistics Output</h3>
            <pre id="detailedStatsOutput">No statistics available yet. Initialize game first.</pre>
        </div>
    </div>

    <!-- Include enhanced game files -->
    <script src="src/dataLoader.js"></script>
    <script src="src/gameState.js"></script>
    <script src="src/quizEngine.js"></script>
    <script src="src/animationManager.js"></script>
    <script src="src/achievementManager.js"></script>
    <script src="src/mapRenderer.js"></script>
    <script src="src/uiManager.js"></script>

    <script>
        let enhancedGameState, enhancedUIManager, enhancedDataLoader, enhancedAchievementManager;
        
        function logEnhancedResult(message, type = 'info') {
            const resultsDiv = document.getElementById('enhancedTestResults');
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.innerHTML += `
                <div class="status ${type}">
                    <strong>[${timestamp}]</strong> ${message}
                </div>
            `;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function initializeEnhancedGame() {
            try {
                logEnhancedResult('🚀 Initializing enhanced game with performance analytics...', 'info');
                
                // Load enhanced game interface
                const response = await fetch('game.html');
                const html = await response.text();
                
                // Extract body content and inject into container
                const bodyMatch = html.match(/<body[^>]*>([\s\S]*)<\/body>/);
                if (bodyMatch) {
                    document.getElementById('enhancedGameContainer').innerHTML = bodyMatch[1];
                    logEnhancedResult('✅ Enhanced game interface loaded', 'success');
                }
                
                // Initialize enhanced components
                enhancedDataLoader = new DataLoader();
                await enhancedDataLoader.loadAllData();
                logEnhancedResult('✅ Enhanced game data loaded', 'success');
                
                enhancedGameState = new GameState(enhancedDataLoader);
                enhancedAchievementManager = new AchievementManager(enhancedGameState, enhancedDataLoader);
                enhancedUIManager = new UIManager(enhancedGameState, null, enhancedDataLoader);
                enhancedUIManager.achievementManager = enhancedAchievementManager;
                
                // Initialize components
                enhancedUIManager.initialize();
                await enhancedAchievementManager.initialize();
                
                logEnhancedResult('✅ Enhanced components initialized', 'success');
                
                updateEnhancedDisplayStats();
                logEnhancedResult('🎮 Enhanced test game ready! All features enabled.', 'success');
                
            } catch (error) {
                logEnhancedResult(`❌ Error initializing enhanced game: ${error.message}`, 'error');
                console.error('Enhanced game initialization error:', error);
            }
        }

        function simulateVariedPerformance() {
            if (!enhancedGameState) {
                logEnhancedResult('❌ Enhanced game not initialized. Click "Initialize Enhanced Game" first.', 'error');
                return;
            }

            try {
                logEnhancedResult('⚡ Simulating varied performance scenario...', 'info');
                
                // Simulate moderate performance (75% accuracy, 80% exploration)
                const totalRooms = enhancedDataLoader.getAllRooms().length;
                const totalQuestions = enhancedDataLoader.getAllQuestions().length;
                const roomsToVisit = Math.ceil(totalRooms * 0.8);
                const questionsToAnswer = Math.ceil(totalQuestions * 0.75);
                const correctAnswers = Math.ceil(questionsToAnswer * 0.75);
                
                // Reset and simulate
                enhancedGameState.reset();
                simulateGameProgress(roomsToVisit, questionsToAnswer, correctAnswers, 900000); // 15 minutes
                
                updateEnhancedDisplayStats();
                logEnhancedResult(`✅ Varied performance: ${correctAnswers}/${questionsToAnswer} correct, ${roomsToVisit} rooms`, 'success');
                
            } catch (error) {
                logEnhancedResult(`❌ Error simulating varied performance: ${error.message}`, 'error');
            }
        }

        function simulatePerfectGame() {
            if (!enhancedGameState) {
                logEnhancedResult('❌ Enhanced game not initialized.', 'error');
                return;
            }

            try {
                logEnhancedResult('🌟 Simulating perfect game scenario...', 'info');
                
                const totalRooms = enhancedDataLoader.getAllRooms().length;
                const totalQuestions = enhancedDataLoader.getAllQuestions().length;
                
                // Perfect game: 100% everything
                enhancedGameState.reset();
                simulateGameProgress(totalRooms, totalQuestions, totalQuestions, 720000); // 12 minutes
                
                updateEnhancedDisplayStats();
                logEnhancedResult(`✅ Perfect game: 100% accuracy, all rooms, all questions!`, 'success');
                
            } catch (error) {
                logEnhancedResult(`❌ Error simulating perfect game: ${error.message}`, 'error');
            }
        }

        function simulateSpeedRun() {
            if (!enhancedGameState) {
                logEnhancedResult('❌ Enhanced game not initialized.', 'error');
                return;
            }

            try {
                logEnhancedResult('🏃‍♂️ Simulating speed run scenario...', 'info');
                
                const totalRooms = enhancedDataLoader.getAllRooms().length;
                const totalQuestions = enhancedDataLoader.getAllQuestions().length;
                const roomsToVisit = Math.ceil(totalRooms * 0.85);
                const questionsToAnswer = Math.ceil(totalQuestions * 0.80);
                const correctAnswers = Math.ceil(questionsToAnswer * 0.90);
                
                // Speed run: under 10 minutes
                enhancedGameState.reset();
                simulateGameProgress(roomsToVisit, questionsToAnswer, correctAnswers, 480000); // 8 minutes
                
                updateEnhancedDisplayStats();
                logEnhancedResult(`✅ Speed run: 90% accuracy in 8 minutes!`, 'success');
                
            } catch (error) {
                logEnhancedResult(`❌ Error simulating speed run: ${error.message}`, 'error');
            }
        }

        function simulateGameProgress(roomsToVisit, questionsToAnswer, correctAnswers, playTime) {
            // Set start time for realistic duration
            enhancedGameState.gameStartTime = Date.now() - playTime;
            enhancedGameState.startTime = Date.now() - playTime;
            
            // Simulate visiting rooms
            for (let i = 0; i < roomsToVisit; i++) {
                const roomId = `room_${i + 1}`;
                if (!enhancedGameState.visitedRooms.has(roomId)) {
                    enhancedGameState.visitedRooms.add(roomId);
                }
            }
            
            // Simulate answering questions
            enhancedGameState.answeredQuestions.clear();
            enhancedGameState.score = 0;
            
            for (let i = 0; i < questionsToAnswer; i++) {
                const questionId = `q${i + 1}`;
                const isCorrect = i < correctAnswers;
                
                enhancedGameState.answeredQuestions.add(questionId);
                
                if (isCorrect) {
                    enhancedGameState.score += 100; // Base points per correct answer
                }
            }
            
            // Check if game is completed (for bonuses)
            enhancedGameState.gameCompleted = enhancedGameState.checkGameCompletion();
        }

        function triggerEnhancedVictory() {
            if (!enhancedGameState) {
                logEnhancedResult('❌ Enhanced game not initialized.', 'error');
                return;
            }

            try {
                logEnhancedResult('🏆 Triggering enhanced victory screen...', 'info');
                
                const stats = enhancedGameState.getGameStatistics();
                const completionData = {
                    finalScore: stats.finalScore,
                    gameState: enhancedGameState,
                    statistics: stats
                };
                
                enhancedUIManager.showVictoryScreen(completionData);
                logEnhancedResult('✅ Enhanced victory screen displayed!', 'success');
                
                // Log detailed statistics
                updateDetailedStatsOutput(stats);
                
            } catch (error) {
                logEnhancedResult(`❌ Error triggering enhanced victory: ${error.message}`, 'error');
                console.error('Enhanced victory trigger error:', error);
            }
        }

        function testReplayFunctionality() {
            if (!enhancedUIManager) {
                logEnhancedResult('❌ Enhanced UI Manager not initialized.', 'error');
                return;
            }

            try {
                logEnhancedResult('🔄 Testing replay functionality...', 'info');
                
                // Simulate play again button click
                enhancedUIManager.handlePlayAgain();
                
                setTimeout(() => {
                    updateEnhancedDisplayStats();
                    logEnhancedResult('✅ Replay functionality tested successfully!', 'success');
                }, 600);
                
            } catch (error) {
                logEnhancedResult(`❌ Error testing replay: ${error.message}`, 'error');
            }
        }

        function testSharingFeature() {
            if (!enhancedUIManager) {
                logEnhancedResult('❌ Enhanced UI Manager not initialized.', 'error');
                return;
            }

            try {
                logEnhancedResult('📤 Testing sharing feature...', 'info');
                
                // Test share functionality
                enhancedUIManager.handleShareResults();
                
                logEnhancedResult('✅ Sharing feature tested! Check for share dialog or clipboard.', 'success');
                
            } catch (error) {
                logEnhancedResult(`❌ Error testing sharing: ${error.message}`, 'error');
            }
        }

        function resetEnhancedGame() {
            try {
                if (enhancedGameState) {
                    enhancedGameState.reset();
                    updateEnhancedDisplayStats();
                    document.getElementById('detailedStatsOutput').textContent = 'Game reset. Play to generate new statistics.';
                    logEnhancedResult('🔄 Enhanced game reset successfully', 'success');
                } else {
                    logEnhancedResult('⚠️ No enhanced game to reset', 'info');
                }
            } catch (error) {
                logEnhancedResult(`❌ Error resetting enhanced game: ${error.message}`, 'error');
            }
        }

        function updateEnhancedDisplayStats() {
            if (!enhancedGameState) return;
            
            try {
                const stats = enhancedGameState.getGameStatistics();
                const grade = enhancedUIManager ? enhancedUIManager.calculatePerformanceGrade(stats) : 'N/A';
                
                document.getElementById('enhancedFinalScore').textContent = stats.finalScore.toLocaleString();
                document.getElementById('enhancedPerformanceGrade').textContent = grade;
                document.getElementById('enhancedPlayTime').textContent = stats.playTimeFormatted;
                document.getElementById('enhancedAccuracy').textContent = `${stats.accuracyPercent}%`;
                document.getElementById('enhancedExploration').textContent = `${stats.roomsExploredPercent}%`;
                
                const achievementCount = enhancedAchievementManager ? 
                    enhancedAchievementManager.getUnlockedAchievements().length : 0;
                document.getElementById('enhancedAchievements').textContent = achievementCount;
                
            } catch (error) {
                console.error('Error updating enhanced display stats:', error);
            }
        }

        function updateDetailedStatsOutput(stats) {
            const output = document.getElementById('detailedStatsOutput');
            output.textContent = JSON.stringify(stats, null, 2);
        }

        // Initialize enhanced test on page load
        document.addEventListener('DOMContentLoaded', () => {
            logEnhancedResult('🧪 Phase 6.3 Enhanced Test Suite Ready', 'success');
            logEnhancedResult('Click "Initialize Enhanced Game" to start testing enhanced performance features', 'info');
        });
    </script>
</body>
</html>