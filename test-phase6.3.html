<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Phase 6.3 - Game Completion Flow</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .test-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        
        button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        button.success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .status.success { background: rgba(46, 204, 113, 0.2); border-left: 4px solid #2ecc71; }
        .status.error { background: rgba(231, 76, 60, 0.2); border-left: 4px solid #e74c3c; }
        .status.info { background: rgba(52, 152, 219, 0.2); border-left: 4px solid #3498db; }
        
        .game-container {
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            min-height: 400px;
        }
        
        .test-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4facfe;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            overflow-x: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .victory-test-info {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .feature-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }
        
        .feature-item h4 {
            margin: 0 0 10px 0;
            color: #4facfe;
        }
        
        .feature-item p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üèÜ Phase 6.3: Game Completion Flow Test</h1>
            <p>Testing victory conditions, victory screen, and game completion statistics</p>
        </div>
        
        <div class="victory-test-info">
            <h3>üéØ Victory Condition Requirements</h3>
            <p>To trigger victory screen, you must achieve:</p>
            <ul>
                <li><strong>80%+ Rooms Explored:</strong> Visit at least 80% of available rooms</li>
                <li><strong>70%+ Questions Answered:</strong> Answer at least 70% of available questions</li>
                <li><strong>70%+ Accuracy Rate:</strong> Get at least 70% of answered questions correct</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üéÆ Game Test Controls</h3>
            <div class="test-controls">
                <button onclick="initializeTestGame()">üöÄ Initialize Game</button>
                <button onclick="simulateGameProgress()" class="success">‚ö° Simulate Game Progress</button>
                <button onclick="triggerVictory()" class="success">üèÜ Trigger Victory Screen</button>
                <button onclick="checkVictoryConditions()">üìä Check Victory Conditions</button>
                <button onclick="showGameStatistics()">üìà Show Game Statistics</button>
                <button onclick="resetTestGame()" class="danger">üîÑ Reset Game</button>
            </div>
        </div>

        <div class="test-section">
            <h3>üéØ Victory Screen Features</h3>
            <div class="feature-list">
                <div class="feature-item">
                    <h4>üìä Performance Statistics</h4>
                    <p>Final score, base score, accuracy/speed/exploration bonuses</p>
                </div>
                <div class="feature-item">
                    <h4>‚è±Ô∏è Timing Analysis</h4>
                    <p>Total time, average question time, performance grade</p>
                </div>
                <div class="feature-item">
                    <h4>üó∫Ô∏è Completion Metrics</h4>
                    <p>Rooms explored %, questions answered %, accuracy rate</p>
                </div>
                <div class="feature-item">
                    <h4>üèÖ Achievement Integration</h4>
                    <p>Display unlocked achievements and total count</p>
                </div>
                <div class="feature-item">
                    <h4>üé¨ Interactive Actions</h4>
                    <p>Play again, view achievements, share results</p>
                </div>
                <div class="feature-item">
                    <h4>üì± Responsive Design</h4>
                    <p>Mobile-friendly with CSS animations and gradients</p>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>üìä Current Game Statistics</h3>
            <div class="test-stats" id="gameStats">
                <div class="stat-card">
                    <div class="stat-value" id="currentScore">0</div>
                    <div class="stat-label">Current Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="roomsVisited">0</div>
                    <div class="stat-label">Rooms Visited</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="questionsAnswered">0</div>
                    <div class="stat-label">Questions Answered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="accuracyRate">0%</div>
                    <div class="stat-label">Accuracy Rate</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>üñ•Ô∏è Game Interface</h3>
            <div class="game-container" id="gameContainer">
                <!-- Game interface will be loaded here -->
            </div>
        </div>

        <div class="test-section">
            <h3>üìã Test Results</h3>
            <div id="testResults"></div>
        </div>
    </div>

    <!-- Include game files -->
    <script src="src/dataLoader.js"></script>
    <script src="src/gameState.js"></script>
    <script src="src/quizEngine.js"></script>
    <script src="src/animationManager.js"></script>
    <script src="src/mapRenderer.js"></script>
    <script src="src/uiManager.js"></script>

    <script>
        let gameState, uiManager, dataLoader;
        
        function logResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.innerHTML += `
                <div class="status ${type}">
                    <strong>[${timestamp}]</strong> ${message}
                </div>
            `;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function initializeTestGame() {
            try {
                logResult('üöÄ Initializing test game...', 'info');
                
                // Load game interface
                const response = await fetch('game.html');
                const html = await response.text();
                
                // Extract body content and inject into container
                const bodyMatch = html.match(/<body[^>]*>([\s\S]*)<\/body>/);
                if (bodyMatch) {
                    document.getElementById('gameContainer').innerHTML = bodyMatch[1];
                    logResult('‚úÖ Game interface loaded', 'success');
                }
                
                // Initialize game components
                dataLoader = new DataLoader();
                await dataLoader.loadAllData();
                logResult('‚úÖ Game data loaded', 'success');
                
                gameState = new GameState(dataLoader);
                uiManager = new UIManager(gameState, null, dataLoader);
                
                // Initialize components
                uiManager.initialize();
                logResult('‚úÖ Game components initialized', 'success');
                
                updateDisplayStats();
                logResult('üéÆ Test game ready! Use controls to test victory conditions.', 'success');
                
            } catch (error) {
                logResult(`‚ùå Error initializing game: ${error.message}`, 'error');
                console.error('Game initialization error:', error);
            }
        }

        function simulateGameProgress() {
            if (!gameState) {
                logResult('‚ùå Game not initialized. Click "Initialize Game" first.', 'error');
                return;
            }

            try {
                logResult('‚ö° Simulating game progress...', 'info');
                
                // Simulate visiting rooms (90% of total)
                const totalRooms = dataLoader.getAllRooms().length;
                const roomsToVisit = Math.ceil(totalRooms * 0.9);
                
                for (let i = 0; i < roomsToVisit; i++) {
                    const roomId = `room_${i + 1}`;
                    if (!gameState.visitedRooms.includes(roomId)) {
                        gameState.visitedRooms.push(roomId);
                    }
                }
                
                // Simulate answering questions (80% of total, 85% accuracy)
                const totalQuestions = dataLoader.getAllQuestions().length;
                const questionsToAnswer = Math.ceil(totalQuestions * 0.8);
                const correctAnswers = Math.ceil(questionsToAnswer * 0.85);
                
                for (let i = 0; i < questionsToAnswer; i++) {
                    const questionId = `q${i + 1}`;
                    const isCorrect = i < correctAnswers;
                    
                    gameState.answeredQuestions.push({
                        questionId: questionId,
                        correct: isCorrect,
                        timeSpent: 15000 + Math.random() * 10000, // 15-25 seconds
                        timestamp: Date.now() - (questionsToAnswer - i) * 30000
                    });
                    
                    if (isCorrect) {
                        gameState.correctAnswers++;
                        gameState.score += 100;
                    }
                }
                
                // Set game start time for realistic duration
                gameState.gameStartTime = Date.now() - (questionsToAnswer * 30000);
                
                updateDisplayStats();
                logResult(`‚úÖ Simulated progress: ${roomsToVisit} rooms, ${questionsToAnswer} questions`, 'success');
                logResult(`üìä Victory conditions should now be met!`, 'success');
                
            } catch (error) {
                logResult(`‚ùå Error simulating progress: ${error.message}`, 'error');
                console.error('Simulation error:', error);
            }
        }

        function triggerVictory() {
            if (!gameState) {
                logResult('‚ùå Game not initialized. Click "Initialize Game" first.', 'error');
                return;
            }

            try {
                logResult('üèÜ Triggering victory screen...', 'info');
                
                // Force victory conditions and trigger completion
                const stats = gameState.getGameStatistics();
                const completionData = {
                    finalScore: stats.finalScore,
                    gameState: gameState,
                    statistics: stats
                };
                
                // Check if victory conditions are met
                const isComplete = gameState.checkGameCompletion();
                
                if (isComplete) {
                    logResult('‚úÖ Victory conditions met! Showing victory screen...', 'success');
                    uiManager.showVictoryScreen(completionData);
                } else {
                    logResult('‚ö†Ô∏è Victory conditions not met. Use "Simulate Game Progress" first.', 'error');
                    const currentStats = gameState.getGameStatistics();
                    logResult(`Current: ${currentStats.roomsExploredPercent}% rooms, ${currentStats.questionsAnsweredPercent}% questions, ${currentStats.accuracyPercent}% accuracy`, 'info');
                }
                
            } catch (error) {
                logResult(`‚ùå Error triggering victory: ${error.message}`, 'error');
                console.error('Victory trigger error:', error);
            }
        }

        function checkVictoryConditions() {
            if (!gameState) {
                logResult('‚ùå Game not initialized. Click "Initialize Game" first.', 'error');
                return;
            }

            try {
                const stats = gameState.getGameStatistics();
                const isComplete = gameState.checkGameCompletion();
                
                logResult('üìä Victory Condition Check:', 'info');
                logResult(`Rooms Explored: ${stats.roomsExploredPercent}% (need 80%+)`, stats.roomsExploredPercent >= 80 ? 'success' : 'error');
                logResult(`Questions Answered: ${stats.questionsAnsweredPercent}% (need 70%+)`, stats.questionsAnsweredPercent >= 70 ? 'success' : 'error');
                logResult(`Accuracy Rate: ${stats.accuracyPercent}% (need 70%+)`, stats.accuracyPercent >= 70 ? 'success' : 'error');
                logResult(`Overall Victory: ${isComplete ? 'MET' : 'NOT MET'}`, isComplete ? 'success' : 'error');
                
            } catch (error) {
                logResult(`‚ùå Error checking conditions: ${error.message}`, 'error');
                console.error('Victory check error:', error);
            }
        }

        function showGameStatistics() {
            if (!gameState) {
                logResult('‚ùå Game not initialized. Click "Initialize Game" first.', 'error');
                return;
            }

            try {
                const stats = gameState.getGameStatistics();
                
                logResult('üìà Detailed Game Statistics:', 'info');
                logResult(`Final Score: ${stats.finalScore.toLocaleString()}`, 'info');
                logResult(`Base Score: ${stats.baseScore.toLocaleString()}`, 'info');
                logResult(`Accuracy Bonus: +${stats.accuracyBonus.toLocaleString()}`, 'info');
                logResult(`Speed Bonus: +${stats.speedBonus.toLocaleString()}`, 'info');
                logResult(`Exploration Bonus: +${stats.explorationBonus.toLocaleString()}`, 'info');
                logResult(`Total Time: ${gameState.formatTime(stats.totalTime)}`, 'info');
                logResult(`Average Question Time: ${gameState.formatTime(stats.avgQuestionTime)}`, 'info');
                
            } catch (error) {
                logResult(`‚ùå Error showing statistics: ${error.message}`, 'error');
                console.error('Statistics error:', error);
            }
        }

        function resetTestGame() {
            try {
                if (gameState) {
                    gameState.reset();
                    updateDisplayStats();
                    logResult('üîÑ Game reset successfully', 'success');
                } else {
                    logResult('‚ö†Ô∏è No game to reset', 'info');
                }
            } catch (error) {
                logResult(`‚ùå Error resetting game: ${error.message}`, 'error');
                console.error('Reset error:', error);
            }
        }

        function updateDisplayStats() {
            if (!gameState) return;
            
            try {
                const stats = gameState.getGameStatistics();
                
                document.getElementById('currentScore').textContent = stats.finalScore.toLocaleString();
                document.getElementById('roomsVisited').textContent = `${gameState.visitedRooms.length} (${stats.roomsExploredPercent}%)`;
                document.getElementById('questionsAnswered').textContent = `${gameState.answeredQuestions.length} (${stats.questionsAnsweredPercent}%)`;
                document.getElementById('accuracyRate').textContent = `${stats.accuracyPercent}%`;
                
            } catch (error) {
                console.error('Error updating display stats:', error);
            }
        }

        // Initialize test on page load
        document.addEventListener('DOMContentLoaded', () => {
            logResult('üß™ Phase 6.3 Test Suite Ready', 'success');
            logResult('Click "Initialize Game" to start testing victory screen functionality', 'info');
        });
    </script>
</body>
</html>