<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LobeLabyrinth - Performance Optimization Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .test-section h2 {
            color: #FFD700;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .test-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.primary {
            background: rgba(76, 175, 80, 0.8);
            border-color: #4CAF50;
        }

        .btn.danger {
            background: rgba(244, 67, 54, 0.8);
            border-color: #F44336;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .test-results {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #4CAF50; }
        .status-warning { background: #FFC107; }
        .status-error { background: #F44336; }
        .status-info { background: #2196F3; }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
            width: 0%;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .comparison-table th,
        .comparison-table td {
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 12px;
            text-align: left;
        }

        .comparison-table th {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }

        .improvement {
            color: #4CAF50;
            font-weight: bold;
        }

        .degradation {
            color: #F44336;
            font-weight: bold;
        }

        .stress-test-container {
            display: none;
            margin-top: 20px;
        }

        .stress-test-container.active {
            display: block;
        }

        #element-pool {
            display: none;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .notification-toast {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            min-width: 300px;
        }

        .notification-toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-success { border-left: 4px solid #4CAF50; }
        .toast-warning { border-left: 4px solid #FFC107; }
        .toast-error { border-left: 4px solid #F44336; }
        .toast-info { border-left: 4px solid #2196F3; }

        .console-output {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Performance Optimization Test Suite</h1>
        
        <!-- Performance Manager Test Section -->
        <div class="test-section">
            <h2>üìä Performance Manager Tests</h2>
            <div class="test-controls">
                <button class="btn primary" onclick="initializePerformanceManager()">Initialize Performance Manager</button>
                <button class="btn" onclick="showPerformanceDashboard()">Show Dashboard (Ctrl+Shift+P)</button>
                <button class="btn" onclick="runPerformanceBaseline()">Run Baseline Test</button>
                <button class="btn danger" onclick="stopAllTests()">Stop All Tests</button>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="fps-metric">--</div>
                    <div class="metric-label">Frame Rate (FPS)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="memory-metric">--</div>
                    <div class="metric-label">Memory Usage (MB)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="dom-metric">--</div>
                    <div class="metric-label">DOM Updates</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="pool-metric">--</div>
                    <div class="metric-label">Pool Hit Rate (%)</div>
                </div>
            </div>
            
            <div class="test-results" id="performance-results"></div>
        </div>

        <!-- Object Pooling Test Section -->
        <div class="test-section">
            <h2>üì¶ Object Pooling Tests</h2>
            <div class="test-controls">
                <button class="btn" onclick="testObjectPooling()">Test Object Pools</button>
                <button class="btn" onclick="stressTestPools()">Stress Test Pools</button>
                <button class="btn" onclick="comparePoolPerformance()">Compare With/Without Pools</button>
                <button class="btn" onclick="showPoolStatistics()">Show Pool Statistics</button>
            </div>
            
            <div id="pooling-progress" class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            
            <div class="test-results" id="pooling-results"></div>
        </div>

        <!-- Lazy Loading Test Section -->
        <div class="test-section">
            <h2>üìö Lazy Loading Tests</h2>
            <div class="test-controls">
                <button class="btn" onclick="testLazyLoading()">Test Lazy Loading</button>
                <button class="btn" onclick="benchmarkDataLoading()">Benchmark Data Loading</button>
                <button class="btn" onclick="testCacheOptimization()">Test Cache Optimization</button>
                <button class="btn" onclick="simulateMemoryPressure()">Simulate Memory Pressure</button>
            </div>
            
            <div class="test-results" id="lazy-loading-results"></div>
        </div>

        <!-- DOM Batching Test Section -->
        <div class="test-section">
            <h2>‚ö° DOM Batching Tests</h2>
            <div class="test-controls">
                <button class="btn" onclick="testDOMBatching()">Test DOM Batching</button>
                <button class="btn" onclick="stressTestDOM()">Stress Test DOM Updates</button>
                <button class="btn" onclick="compareUpdateMethods()">Compare Update Methods</button>
                <button class="btn" onclick="measureReflowRepaints()">Measure Reflow/Repaints</button>
            </div>
            
            <div class="test-results" id="dom-batching-results"></div>
        </div>

        <!-- Stress Testing Section -->
        <div class="test-section">
            <h2>üî• Stress Testing</h2>
            <div class="test-controls">
                <button class="btn" onclick="runComprehensiveStressTest()">Run Comprehensive Stress Test</button>
                <button class="btn" onclick="simulateGameplayLoad()">Simulate Gameplay Load</button>
                <button class="btn" onclick="testMemoryLeaks()">Test Memory Leaks</button>
                <button class="btn" onclick="generatePerformanceReport()">Generate Performance Report</button>
            </div>
            
            <div class="stress-test-container" id="stress-test-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="stress-progress"></div>
                </div>
                <div class="console-output" id="stress-console"></div>
            </div>
        </div>

        <!-- Performance Comparison -->
        <div class="test-section">
            <h2>üìà Performance Comparison</h2>
            <div class="test-controls">
                <button class="btn" onclick="generateComparisonReport()">Generate Before/After Report</button>
                <button class="btn" onclick="exportTestResults()">Export Test Results</button>
                <button class="btn" onclick="resetAllMetrics()">Reset All Metrics</button>
            </div>
            
            <table class="comparison-table" id="comparison-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                        <th>Without Optimization</th>
                        <th>With Optimization</th>
                        <th>Improvement</th>
                    </tr>
                </thead>
                <tbody id="comparison-body">
                    <tr>
                        <td colspan="4">Run tests to see comparison data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Hidden element pool for testing -->
    <div id="element-pool"></div>

    <!-- Include all performance optimization scripts -->
    <script src="../src/performanceManager.js"></script>
    <script src="../src/uiOptimizations.js"></script>
    <script src="../src/enhancedDataLoader.js"></script>
    <script src="../src/enhancedUIManager.js"></script>
    <script src="../src/performanceMonitoringDashboard.js"></script>

    <!-- Include original game files for comparison -->
    <script src="../src/dataLoader.js"></script>
    <script src="../src/gameState.js"></script>
    <script src="../src/uiManager.js"></script>

    <script>
        // Global test state
        let performanceManager = null;
        let dashboard = null;
        let testResults = {
            baseline: {},
            optimized: {},
            comparisons: []
        };
        let isTestRunning = false;

        /**
         * Initialize Performance Manager
         */
        function initializePerformanceManager() {
            if (performanceManager) {
                log('performance-results', '‚ö†Ô∏è Performance Manager already initialized');
                return;
            }

            try {
                performanceManager = new PerformanceManager();
                dashboard = new PerformanceMonitoringDashboard(performanceManager);
                
                // Start monitoring
                performanceManager.startPerformanceMonitoring();
                
                // Update metrics display every second
                setInterval(updateMetricsDisplay, 1000);
                
                log('performance-results', '‚úÖ Performance Manager initialized successfully');
                showToast('success', 'Initialization Complete', 'Performance Manager is now active');
                
            } catch (error) {
                log('performance-results', `‚ùå Error initializing Performance Manager: ${error.message}`);
                showToast('error', 'Initialization Failed', error.message);
            }
        }

        /**
         * Show performance dashboard
         */
        function showPerformanceDashboard() {
            if (!dashboard) {
                showToast('warning', 'Dashboard Not Available', 'Initialize Performance Manager first');
                return;
            }
            
            dashboard.show();
            log('performance-results', 'üìä Performance dashboard displayed');
        }

        /**
         * Run performance baseline test
         */
        async function runPerformanceBaseline() {
            if (!performanceManager) {
                showToast('error', 'Performance Manager Required', 'Initialize Performance Manager first');
                return;
            }

            if (isTestRunning) {
                showToast('warning', 'Test In Progress', 'Please wait for current test to complete');
                return;
            }

            isTestRunning = true;
            log('performance-results', 'üèÉ Running performance baseline test...');
            
            try {
                const startTime = performance.now();
                
                // Simulate various operations
                await simulateDataLoading();
                await simulateDOMOperations();
                await simulateUIUpdates();
                
                const endTime = performance.now();
                const totalTime = endTime - startTime;
                
                testResults.baseline = {
                    totalTime,
                    metrics: performanceManager.getMetrics(),
                    timestamp: new Date().toISOString()
                };
                
                log('performance-results', `‚úÖ Baseline test completed in ${totalTime.toFixed(2)}ms`);
                showToast('success', 'Baseline Complete', `Test completed in ${totalTime.toFixed(0)}ms`);
                
            } catch (error) {
                log('performance-results', `‚ùå Baseline test failed: ${error.message}`);
                showToast('error', 'Baseline Failed', error.message);
            } finally {
                isTestRunning = false;
            }
        }

        /**
         * Test object pooling functionality
         */
        function testObjectPooling() {
            if (!performanceManager) {
                initializePerformanceManager();
            }

            log('pooling-results', 'üì¶ Testing object pooling...');
            
            try {
                // Create various pools
                performanceManager.createPool('testButtons', UIFactories.answerButton, 5);
                performanceManager.createPool('testNotifications', UIFactories.notificationToast, 3);
                performanceManager.createPool('testConnections', UIFactories.roomConnection, 8);
                
                // Test pool operations
                const testRuns = 100;
                const startTime = performance.now();
                
                for (let i = 0; i < testRuns; i++) {
                    // Acquire objects
                    const button = performanceManager.acquireFromPool('testButtons');
                    const notification = performanceManager.acquireFromPool('testNotifications');
                    const connection = performanceManager.acquireFromPool('testConnections');
                    
                    // Use objects (simulate work)
                    button.textContent = `Test ${i}`;
                    notification.querySelector('.toast-title').textContent = `Notification ${i}`;
                    connection.querySelector('.connection-link').textContent = `Connection ${i}`;
                    
                    // Return to pool
                    performanceManager.releaseToPool('testButtons', button);
                    performanceManager.releaseToPool('testNotifications', notification);
                    performanceManager.releaseToPool('testConnections', connection);
                }
                
                const endTime = performance.now();
                const poolTime = endTime - startTime;
                
                // Test without pooling for comparison
                const startTimeNoPool = performance.now();
                
                for (let i = 0; i < testRuns; i++) {
                    // Create new objects each time
                    const button = UIFactories.answerButton();
                    const notification = UIFactories.notificationToast();
                    const connection = UIFactories.roomConnection();
                    
                    // Use objects
                    button.textContent = `Test ${i}`;
                    notification.querySelector('.toast-title').textContent = `Notification ${i}`;
                    connection.querySelector('.connection-link').textContent = `Connection ${i}`;
                    
                    // No cleanup - simulate garbage collection pressure
                }
                
                const endTimeNoPool = performance.now();
                const noPoolTime = endTimeNoPool - startTimeNoPool;
                
                const improvement = ((noPoolTime - poolTime) / noPoolTime * 100);
                
                log('pooling-results', `‚úÖ Pool test completed:`);
                log('pooling-results', `   With pooling: ${poolTime.toFixed(2)}ms`);
                log('pooling-results', `   Without pooling: ${noPoolTime.toFixed(2)}ms`);
                log('pooling-results', `   Performance improvement: ${improvement.toFixed(1)}%`);
                
                // Show pool statistics
                showPoolStatistics();
                
                showToast('success', 'Pooling Test Complete', `${improvement.toFixed(1)}% improvement achieved`);
                
            } catch (error) {
                log('pooling-results', `‚ùå Object pooling test failed: ${error.message}`);
                showToast('error', 'Pooling Test Failed', error.message);
            }
        }

        /**
         * Show pool statistics
         */
        function showPoolStatistics() {
            if (!performanceManager) {
                showToast('warning', 'No Performance Manager', 'Initialize Performance Manager first');
                return;
            }

            log('pooling-results', 'üìä Pool Statistics:');
            
            for (const [poolName] of performanceManager.objectPools) {
                const stats = performanceManager.getPoolStats(poolName);
                if (stats) {
                    log('pooling-results', `   ${stats.name}: ${stats.hits}/${stats.hits + stats.misses} hits (${stats.hitRate.toFixed(1)}%)`);
                    log('pooling-results', `     Available: ${stats.available}, In Use: ${stats.inUse}, Created: ${stats.created}`);
                }
            }
        }

        /**
         * Test lazy loading functionality
         */
        async function testLazyLoading() {
            log('lazy-loading-results', 'üìö Testing lazy loading...');
            
            try {
                // Create mock data loader
                const mockDataLoader = {
                    getQuestions: () => {
                        // Generate mock questions for different categories
                        const categories = ['science', 'history', 'literature', 'mathematics', 'geography', 'general'];
                        const questions = [];
                        
                        for (let i = 0; i < 1000; i++) {
                            questions.push({
                                id: `q${i}`,
                                question: `Question ${i}`,
                                category: categories[i % categories.length],
                                difficulty: ['easy', 'medium', 'hard'][i % 3],
                                answers: [`Answer A${i}`, `Answer B${i}`, `Answer C${i}`, `Answer D${i}`],
                                correctAnswer: i % 4,
                                points: 100
                            });
                        }
                        
                        return questions;
                    }
                };
                
                // Test standard loading vs enhanced loading
                const enhancedLoader = new EnhancedDataLoader(mockDataLoader, performanceManager);
                
                // Test category loading
                const startTime = performance.now();
                
                const scienceQuestions = await enhancedLoader.getQuestionsByCategory('science');
                const historyQuestions = await enhancedLoader.getQuestionsByCategory('history');
                const mathQuestions = await enhancedLoader.getQuestionsByCategory('mathematics');
                
                const endTime = performance.now();
                const loadTime = endTime - startTime;
                
                log('lazy-loading-results', `‚úÖ Lazy loading test completed:`);
                log('lazy-loading-results', `   Science questions: ${scienceQuestions.length}`);
                log('lazy-loading-results', `   History questions: ${historyQuestions.length}`);
                log('lazy-loading-results', `   Math questions: ${mathQuestions.length}`);
                log('lazy-loading-results', `   Total load time: ${loadTime.toFixed(2)}ms`);
                
                // Test cache performance
                const cacheStartTime = performance.now();
                const cachedScience = await enhancedLoader.getQuestionsByCategory('science');
                const cacheEndTime = performance.now();
                const cacheTime = cacheEndTime - cacheStartTime;
                
                log('lazy-loading-results', `   Cache retrieval time: ${cacheTime.toFixed(2)}ms`);
                log('lazy-loading-results', `   Cache speedup: ${(loadTime / cacheTime).toFixed(1)}x faster`);
                
                // Show cache statistics
                const cacheStats = enhancedLoader.getCacheStats();
                log('lazy-loading-results', `üìä Cache Statistics:`);
                log('lazy-loading-results', `   Cache size: ${cacheStats.cacheSize} categories`);
                log('lazy-loading-results', `   Memory usage: ${(cacheStats.memoryUsage / 1024).toFixed(1)}KB`);
                
                showToast('success', 'Lazy Loading Complete', `Cache is ${(loadTime / cacheTime).toFixed(1)}x faster`);
                
            } catch (error) {
                log('lazy-loading-results', `‚ùå Lazy loading test failed: ${error.message}`);
                showToast('error', 'Lazy Loading Failed', error.message);
            }
        }

        /**
         * Test DOM batching
         */
        function testDOMBatching() {
            if (!performanceManager) {
                initializePerformanceManager();
            }

            log('dom-batching-results', '‚ö° Testing DOM batching...');
            
            try {
                const testContainer = document.getElementById('element-pool');
                const updateCount = 200;
                
                // Test with batching
                const startTimeBatched = performance.now();
                
                for (let i = 0; i < updateCount; i++) {
                    const element = document.createElement('div');
                    element.id = `test-element-${i}`;
                    testContainer.appendChild(element);
                    
                    // Batch multiple updates
                    performanceManager.batchDOMUpdate(() => {
                        element.textContent = `Element ${i}`;
                        element.className = `test-class-${i % 10}`;
                        element.style.background = `hsl(${i * 3.6}, 50%, 50%)`;
                    });
                }
                
                setTimeout(() => {
                    const endTimeBatched = performance.now();
                    const batchedTime = endTimeBatched - startTimeBatched;
                    
                    // Clear container
                    testContainer.innerHTML = '';
                    
                    // Test without batching
                    const startTimeUnbatched = performance.now();
                    
                    for (let i = 0; i < updateCount; i++) {
                        const element = document.createElement('div');
                        element.id = `test-element-${i}`;
                        testContainer.appendChild(element);
                        
                        // Direct DOM updates
                        element.textContent = `Element ${i}`;
                        element.className = `test-class-${i % 10}`;
                        element.style.background = `hsl(${i * 3.6}, 50%, 50%)`;
                    }
                    
                    const endTimeUnbatched = performance.now();
                    const unbatchedTime = endTimeUnbatched - startTimeUnbatched;
                    
                    const improvement = ((unbatchedTime - batchedTime) / unbatchedTime * 100);
                    
                    log('dom-batching-results', `‚úÖ DOM batching test completed:`);
                    log('dom-batching-results', `   With batching: ${batchedTime.toFixed(2)}ms`);
                    log('dom-batching-results', `   Without batching: ${unbatchedTime.toFixed(2)}ms`);
                    log('dom-batching-results', `   Performance improvement: ${improvement.toFixed(1)}%`);
                    
                    // Clear test container
                    testContainer.innerHTML = '';
                    
                    showToast('success', 'DOM Batching Complete', `${improvement.toFixed(1)}% improvement achieved`);
                    
                }, 100); // Wait for batched updates to complete
                
            } catch (error) {
                log('dom-batching-results', `‚ùå DOM batching test failed: ${error.message}`);
                showToast('error', 'DOM Batching Failed', error.message);
            }
        }

        /**
         * Run comprehensive stress test
         */
        async function runComprehensiveStressTest() {
            if (isTestRunning) {
                showToast('warning', 'Test In Progress', 'Please wait for current test to complete');
                return;
            }

            isTestRunning = true;
            const stressContainer = document.getElementById('stress-test-container');
            const progressBar = document.getElementById('stress-progress');
            const console = document.getElementById('stress-console');
            
            stressContainer.classList.add('active');
            console.textContent = '';
            
            try {
                log('stress-console', 'üî• Starting comprehensive stress test...\n');
                
                const totalSteps = 10;
                let currentStep = 0;
                
                const updateProgress = (step, message) => {
                    currentStep = step;
                    const percentage = (step / totalSteps) * 100;
                    progressBar.style.width = `${percentage}%`;
                    log('stress-console', `[${step}/${totalSteps}] ${message}\n`);
                };
                
                // Step 1: Initialize systems
                updateProgress(1, 'Initializing performance systems...');
                if (!performanceManager) {
                    initializePerformanceManager();
                }
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 2: Memory stress test
                updateProgress(2, 'Running memory stress test...');
                const memoryObjects = [];
                for (let i = 0; i < 10000; i++) {
                    memoryObjects.push(new Array(100).fill(Math.random()));
                    if (i % 1000 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                // Step 3: Object pool stress test
                updateProgress(3, 'Testing object pool under load...');
                for (let i = 0; i < 1000; i++) {
                    const obj = performanceManager.acquireFromPool('testButtons');
                    performanceManager.releaseToPool('testButtons', obj);
                }
                
                // Step 4: DOM stress test
                updateProgress(4, 'Running DOM manipulation stress test...');
                const testContainer = document.getElementById('element-pool');
                for (let i = 0; i < 500; i++) {
                    performanceManager.batchDOMUpdate(() => {
                        const element = document.createElement('div');
                        element.textContent = `Stress ${i}`;
                        testContainer.appendChild(element);
                    });
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Step 5: Lazy loading stress test
                updateProgress(5, 'Testing lazy loading under pressure...');
                // Simulate concurrent loading requests
                const loadPromises = [];
                const categories = ['science', 'history', 'literature', 'mathematics'];
                for (let i = 0; i < 50; i++) {
                    const category = categories[i % categories.length];
                    // Would use enhanced loader here if available
                    loadPromises.push(new Promise(resolve => setTimeout(resolve, Math.random() * 100)));
                }
                await Promise.all(loadPromises);
                
                // Step 6: Animation stress test
                updateProgress(6, 'Testing animation performance...');
                const animationPromises = [];
                for (let i = 0; i < 50; i++) {
                    animationPromises.push(new Promise(resolve => {
                        requestAnimationFrame(() => {
                            // Simulate animation work
                            const start = performance.now();
                            while (performance.now() - start < 2) {
                                // Busy wait to simulate animation calculations
                            }
                            resolve();
                        });
                    }));
                }
                await Promise.all(animationPromises);
                
                // Step 7: Event handling stress test
                updateProgress(7, 'Testing event handling performance...');
                const testElement = document.createElement('div');
                for (let i = 0; i < 1000; i++) {
                    testElement.addEventListener('click', () => {});
                }
                
                // Step 8: Memory cleanup test
                updateProgress(8, 'Testing memory cleanup...');
                memoryObjects.length = 0; // Clear array
                testContainer.innerHTML = ''; // Clear DOM
                
                // Step 9: Performance metrics collection
                updateProgress(9, 'Collecting performance metrics...');
                const finalMetrics = performanceManager.getMetrics();
                
                // Step 10: Generate report
                updateProgress(10, 'Generating stress test report...');
                
                log('stress-console', '\nüìä STRESS TEST RESULTS:\n');
                log('stress-console', `Frame Rate: ${finalMetrics.frameRate.toFixed(1)} FPS\n`);
                log('stress-console', `Memory Usage: ${finalMetrics.memoryUsage.toFixed(1)} MB\n`);
                log('stress-console', `DOM Updates: ${finalMetrics.domUpdates}\n`);
                log('stress-console', `Pool Hit Rate: ${((finalMetrics.poolHits / (finalMetrics.poolHits + finalMetrics.poolMisses)) * 100).toFixed(1)}%\n`);
                log('stress-console', '\n‚úÖ Stress test completed successfully!');
                
                showToast('success', 'Stress Test Complete', 'All systems performed within acceptable limits');
                
            } catch (error) {
                log('stress-console', `\n‚ùå Stress test failed: ${error.message}`);
                showToast('error', 'Stress Test Failed', error.message);
            } finally {
                isTestRunning = false;
            }
        }

        /**
         * Generate performance comparison report
         */
        function generateComparisonReport() {
            const tbody = document.getElementById('comparison-body');
            
            if (!testResults.baseline.metrics) {
                tbody.innerHTML = '<tr><td colspan="4">Run baseline test first to generate comparison</td></tr>';
                return;
            }
            
            const baseline = testResults.baseline.metrics;
            const current = performanceManager ? performanceManager.getMetrics() : baseline;
            
            const comparisons = [
                {
                    metric: 'Frame Rate (FPS)',
                    baseline: baseline.frameRate.toFixed(1),
                    optimized: current.frameRate.toFixed(1),
                    improvement: ((current.frameRate - baseline.frameRate) / baseline.frameRate * 100).toFixed(1)
                },
                {
                    metric: 'Memory Usage (MB)',
                    baseline: baseline.memoryUsage.toFixed(1),
                    optimized: current.memoryUsage.toFixed(1),
                    improvement: ((baseline.memoryUsage - current.memoryUsage) / baseline.memoryUsage * 100).toFixed(1)
                },
                {
                    metric: 'DOM Updates',
                    baseline: baseline.domUpdates,
                    optimized: current.domUpdates,
                    improvement: ((baseline.domUpdates - current.domUpdates) / Math.max(baseline.domUpdates, 1) * 100).toFixed(1)
                }
            ];
            
            tbody.innerHTML = comparisons.map(comp => {
                const improvementNum = parseFloat(comp.improvement);
                const improvementClass = improvementNum > 0 ? 'improvement' : 'degradation';
                const improvementText = improvementNum > 0 ? `+${comp.improvement}%` : `${comp.improvement}%`;
                
                return `
                    <tr>
                        <td>${comp.metric}</td>
                        <td>${comp.baseline}</td>
                        <td>${comp.optimized}</td>
                        <td class="${improvementClass}">${improvementText}</td>
                    </tr>
                `;
            }).join('');
            
            showToast('info', 'Comparison Report Generated', 'Check the comparison table below');
        }

        /**
         * Update metrics display
         */
        function updateMetricsDisplay() {
            if (!performanceManager) return;
            
            const metrics = performanceManager.getMetrics();
            
            document.getElementById('fps-metric').textContent = metrics.frameRate.toFixed(1);
            document.getElementById('memory-metric').textContent = metrics.memoryUsage.toFixed(1);
            document.getElementById('dom-metric').textContent = metrics.domUpdates;
            
            const totalRequests = metrics.poolHits + metrics.poolMisses;
            const hitRate = totalRequests > 0 ? (metrics.poolHits / totalRequests * 100) : 100;
            document.getElementById('pool-metric').textContent = hitRate.toFixed(1);
        }

        /**
         * Utility function to log messages
         */
        function log(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent += message + '\n';
                element.scrollTop = element.scrollHeight;
            }
        }

        /**
         * Show toast notification
         */
        function showToast(type, title, message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `notification-toast toast-${type}`;
            toast.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">${title}</div>
                <div>${message}</div>
            `;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Remove after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        /**
         * Stop all running tests
         */
        function stopAllTests() {
            isTestRunning = false;
            
            if (performanceManager) {
                performanceManager.cleanup();
                performanceManager = null;
            }
            
            if (dashboard) {
                dashboard.cleanup();
                dashboard = null;
            }
            
            const stressContainer = document.getElementById('stress-test-container');
            stressContainer.classList.remove('active');
            
            showToast('info', 'Tests Stopped', 'All running tests have been terminated');
        }

        // Placeholder functions for additional tests
        function stressTestPools() { showToast('info', 'Feature', 'Stress testing object pools...'); }
        function comparePoolPerformance() { showToast('info', 'Feature', 'Comparing pool performance...'); }
        function benchmarkDataLoading() { showToast('info', 'Feature', 'Benchmarking data loading...'); }
        function testCacheOptimization() { showToast('info', 'Feature', 'Testing cache optimization...'); }
        function simulateMemoryPressure() { showToast('info', 'Feature', 'Simulating memory pressure...'); }
        function stressTestDOM() { showToast('info', 'Feature', 'Stress testing DOM updates...'); }
        function compareUpdateMethods() { showToast('info', 'Feature', 'Comparing update methods...'); }
        function measureReflowRepaints() { showToast('info', 'Feature', 'Measuring reflow/repaints...'); }
        function simulateGameplayLoad() { showToast('info', 'Feature', 'Simulating gameplay load...'); }
        function testMemoryLeaks() { showToast('info', 'Feature', 'Testing for memory leaks...'); }
        function generatePerformanceReport() { showToast('info', 'Feature', 'Generating performance report...'); }
        function exportTestResults() { showToast('info', 'Feature', 'Exporting test results...'); }
        function resetAllMetrics() { 
            testResults = { baseline: {}, optimized: {}, comparisons: [] };
            showToast('info', 'Reset Complete', 'All metrics have been reset'); 
        }

        // Helper functions for simulation
        async function simulateDataLoading() {
            return new Promise(resolve => setTimeout(resolve, 100));
        }

        async function simulateDOMOperations() {
            const container = document.getElementById('element-pool');
            for (let i = 0; i < 50; i++) {
                const element = document.createElement('div');
                element.textContent = `Baseline ${i}`;
                container.appendChild(element);
                await new Promise(resolve => setTimeout(resolve, 1));
            }
            container.innerHTML = '';
        }

        async function simulateUIUpdates() {
            return new Promise(resolve => {
                let count = 0;
                const interval = setInterval(() => {
                    document.getElementById('fps-metric').textContent = Math.random().toFixed(1);
                    count++;
                    if (count >= 10) {
                        clearInterval(interval);
                        resolve();
                    }
                }, 10);
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            showToast('info', 'Test Suite Ready', 'Performance optimization test suite loaded');
        });
    </script>
</body>
</html>