<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LobeLabyrinth - A MindMaze Adventure</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Navigate the castle of knowledge through wisdom and wit in this medieval-themed educational game">
    <meta name="theme-color" content="#D4AF37">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="LobeLabyrinth">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjMkMxODEwIiByeD0iMjQiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjRDRBRjM3Ij4KPHA+8J+PsD48L3A+Cjwvc3ZnPgo8L3N2Zz4K">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/game.css">
    <link rel="stylesheet" href="css/achievements.css">
    <link rel="stylesheet" href="css/victory.css">
    <link rel="stylesheet" href="css/accessibility.css">
</head>
<body>
    <!-- Skip Links for Accessibility -->
    <div class="skip-links">
        <a href="#main-content" class="skip-link">Skip to main content</a>
        <a href="#game-controls" class="skip-link">Skip to game controls</a>
        <a href="#achievement-stats" class="skip-link">Skip to achievements</a>
    </div>

    <div class="game-container">
        <!-- Header -->
        <div class="game-header" role="banner">
            <h1>üè∞ LobeLabyrinth</h1>
            <p>Navigate the castle of knowledge through wisdom and wit</p>
        </div>

        <!-- Main Game Area -->
        <main id="main-content" class="game-main" role="main">
            <!-- Castle Map -->
                        <!-- Castle Map -->
            <section id="map-area" class="section" aria-labelledby="map-title">
                <div class="map-header">
                    <h3 id="map-title">üó∫Ô∏è Castle Map</h3>
                    <p>Navigate the castle by clicking on rooms</p>
                </div>
                <canvas id="map-canvas" 
                        width="400" 
                        height="300" 
                        role="img" 
                        aria-label="Interactive castle map showing current location and available rooms"
                        tabindex="0">
                    Your browser does not support the HTML5 Canvas element required for the castle map.
                </canvas>
                <div class="map-legend" role="img" aria-label="Map legend">
                    <div class="legend-item">
                        <div class="legend-color legend-current"></div>
                        <span>Current</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-visited"></div>
                        <span>Visited</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-accessible"></div>
                        <span>Available</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-locked"></div>
                        <span>Locked</span>
                    </div>
                </div>
            </section>

            <!-- Room Information -->
            <section id="room-info" class="section" aria-labelledby="room-name">
                <h2 id="room-name">Loading...</h2>
                <p id="room-description">Initializing game...</p>
                <p id="room-connections"></p>
            </section>

            <!-- Question Area -->
            <section id="question-area" class="section" aria-labelledby="question-heading">
                <h3 id="question-heading">Question</h3>
                <div id="question-text" role="region" aria-live="polite" tabindex="0"></div>
                <div class="question-meta" role="region" aria-label="Question metadata">
                    <div class="meta-item">Category: <span id="question-category"></span></div>
                    <div class="meta-item">Difficulty: <span id="question-difficulty"></span></div>
                    <div class="meta-item">Points: <span id="question-points"></span></div>
                </div>
            </section>

            <!-- Timer -->
            <section id="timer-area" class="section" aria-labelledby="timer-heading">
                <h3 id="timer-heading" class="sr-only">Question Timer</h3>
                <div class="timer-container" role="timer" aria-label="Time remaining for current question">
                    <div id="timer-text" aria-live="polite">30s</div>
                    <div class="timer-bar-container" role="progressbar" aria-valuemin="0" aria-valuemax="30" aria-valuenow="30">
                        <div id="timer-bar"></div>
                    </div>
                </div>
            </section>

            <!-- Answer Area -->
            <section id="answer-area" class="section" aria-labelledby="answer-heading">
                <h3 id="answer-heading">Choose Your Answer</h3>
                <div id="answer-buttons" role="radiogroup" aria-labelledby="answer-heading" aria-required="true"></div>
            </section>

            <!-- Feedback Area -->
            <div id="feedback-area" role="status" aria-live="polite" aria-atomic="true"></div>
            
            <!-- Loading States -->
            <div id="loading-overlay" class="loading-overlay" style="display: none;" aria-hidden="true">
                <div class="loading-content">
                    <div class="loading">
                        <div class="spinner" aria-hidden="true"></div>
                    </div>
                    <div class="loading-text" id="loading-text">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="game-sidebar" role="complementary" aria-label="Game information and controls">
            <!-- Score Display -->
            <section id="score-display" class="section" aria-labelledby="progress-heading">
                <h3 id="progress-heading">Your Progress</h3>
                <div class="score-item">
                    <span>Score:</span>
                    <span class="score-value" id="current-score" aria-live="polite">0</span>
                </div>
                <div class="score-item">
                    <span>Questions Answered:</span>
                    <span class="score-value" id="questions-answered" aria-live="polite">0</span>
                </div>
                <div class="score-item">
                    <span>Rooms Visited:</span>
                    <span class="score-value" id="rooms-visited" aria-live="polite">1</span>
                </div>
            </section>

            <!-- Progress Indicators -->
            <div id="progress-indicators" class="section">
                <h3>Game Progress</h3>
                
                <!-- Overall Progress -->
                <div class="progress-item">
                    <div class="progress-label">
                        <span>Overall Completion</span>
                        <span class="progress-percent" id="overall-progress-percent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="overall-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Room Exploration -->
                <div class="progress-item">
                    <div class="progress-label">
                        <span>Rooms Explored</span>
                        <span class="progress-percent" id="rooms-progress-percent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill rooms-fill" id="rooms-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Accuracy Progress -->
                <div class="progress-item">
                    <div class="progress-label">
                        <span>Answer Accuracy</span>
                        <span class="progress-percent" id="accuracy-progress-percent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill accuracy-fill" id="accuracy-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Time Progress (visual indicator) -->
                <div class="progress-item">
                    <div class="progress-label">
                        <span>Play Time</span>
                        <span class="progress-percent" id="play-time-display">0m 0s</span>
                    </div>
                    <div class="time-indicator">
                        <div class="time-pulse" id="time-pulse"></div>
                    </div>
                </div>
            </div>

            <!-- Game Status -->
            <div id="game-status" class="section">
                <h3>Game Status</h3>
                <div class="status-message">Initializing game...</div>
            </div>

            <!-- Game Controls -->
            <div id="game-controls" class="section">
                <h3>Actions</h3>
                <button id="new-question-btn" 
                        class="btn-primary" 
                        type="button" 
                        aria-describedby="new-question-help"
                        accesskey="n">
                    üé≤ New Question
                </button>
                <div class="controls-grid">
                    <button id="hint-btn" 
                            disabled 
                            type="button" 
                            aria-describedby="hint-help"
                            accesskey="h">
                        üí° Hint
                    </button>
                    <button id="skip-btn" 
                            disabled 
                            type="button" 
                            aria-describedby="skip-help"
                            accesskey="s">
                        ‚è≠Ô∏è Skip
                    </button>
                </div>
                <div class="controls-grid">
                    <button id="save-btn" 
                            class="btn-secondary" 
                            type="button" 
                            aria-describedby="save-help"
                            accesskey="v">
                        üíæ Save
                    </button>
                    <button id="load-btn" 
                            class="btn-secondary" 
                            type="button" 
                            aria-describedby="load-help"
                            accesskey="l">
                        üìÅ Load
                    </button>
                </div>
                <button id="reset-btn" 
                        class="btn-danger" 
                        type="button" 
                        aria-describedby="reset-help"
                        aria-label="Reset game - this will delete all progress">
                    üîÑ Reset Game
                </button>
                
                <!-- Hidden help text for screen readers -->
                <div class="sr-only">
                    <div id="new-question-help">Get a new question to answer. Keyboard shortcut: Alt+N</div>
                    <div id="hint-help">Get a hint for the current question. Keyboard shortcut: Alt+H</div>
                    <div id="skip-help">Skip the current question. Keyboard shortcut: Alt+S</div>
                    <div id="save-help">Save your current game progress. Keyboard shortcut: Alt+V</div>
                    <div id="load-help">Load your saved game progress. Keyboard shortcut: Alt+L</div>
                    <div id="reset-help">Reset the entire game, clearing all progress</div>
                </div>
            </div>

            <!-- Navigation -->
            <div id="navigation-area" class="section">
                <h3>Navigation</h3>
                <div id="available-rooms">
                    <p>Answer questions to unlock new rooms!</p>
                </div>
            </div>

            <!-- Achievement Stats -->
            <div id="achievement-stats" class="section">
                <h3>üèÜ Achievements</h3>
                <div class="achievement-stats-summary" id="achievement-stats-summary" aria-live="polite">
                    0/12 (0%)
                    <span class="achievement-points">+0 pts</span>
                </div>
                <button id="achievement-toggle" 
                        class="btn-secondary" 
                        type="button"
                        aria-describedby="achievement-help"
                        aria-expanded="false"
                        aria-controls="achievement-gallery"
                        accesskey="a">
                    üèÜ View Gallery
                </button>
                <div class="sr-only">
                    <div id="achievement-help">Open achievement gallery to view all unlocked achievements. Keyboard shortcut: Alt+A</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="game-footer">
            <div id="game-status-footer">
                <span class="loading"></span> Initializing game...
            </div>
        </div>
    </div>

    <!-- Achievement Gallery (Hidden by default) -->
    <div id="achievement-gallery" class="achievement-gallery" style="display: none;">
        <div class="achievement-gallery-content">
            <div class="achievement-gallery-header">
                <h3>üèÜ Achievements</h3>
                <div class="achievement-summary" id="achievement-summary">
                    0/12 unlocked (0%)
                    <br>
                    0 total points
                </div>
                <button class="achievement-close-btn" id="achievement-gallery-close" aria-label="Close achievement gallery">√ó</button>
            </div>
            <div class="achievement-categories" id="achievement-categories">
                <!-- Content will be dynamically populated -->
            </div>
        </div>
    </div>

    <!-- Achievement Notification (Hidden by default) -->
    <div id="achievement-notification" class="achievement-notification">
        <!-- Content will be dynamically populated -->
    </div>

    <!-- Victory Screen (Hidden by default) -->
    <div id="victory-screen" class="victory-screen">
        <div class="victory-content">
            <div class="victory-header">
                <div class="victory-title">üèÜ Congratulations! üèÜ</div>
                <div class="victory-subtitle">You have completed LobeLabyrinth!</div>
            </div>
            
            <div class="victory-stats">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-label">Final Score</div>
                        <div class="stat-value" id="victory-final-score">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è±Ô∏è</div>
                        <div class="stat-label">Time Taken</div>
                        <div class="stat-value" id="victory-time">0m 0s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-label">Accuracy</div>
                        <div class="stat-value" id="victory-accuracy">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üó∫Ô∏è</div>
                        <div class="stat-label">Rooms Explored</div>
                        <div class="stat-value" id="victory-rooms">0/0</div>
                    </div>
                </div>
                
                <div class="performance-breakdown">
                    <h3>Performance Breakdown</h3>
                    <div class="breakdown-grid">
                        <div class="breakdown-item">
                            <span>Base Score:</span>
                            <span id="victory-base-score">0</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Completion Bonus:</span>
                            <span id="victory-completion-bonus">+500</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Exploration Bonus:</span>
                            <span id="victory-exploration-bonus">+0</span>
                        </div>
                        <div class="breakdown-item" id="victory-perfect-bonus-item" style="display: none;">
                            <span>Perfect Game Bonus:</span>
                            <span id="victory-perfect-bonus">+1000</span>
                        </div>
                        <div class="breakdown-item" id="victory-speed-bonus-item" style="display: none;">
                            <span>Speed Run Bonus:</span>
                            <span id="victory-speed-bonus">+750</span>
                        </div>
                        <div class="breakdown-item" id="victory-achievement-bonus-item">
                            <span>Achievement Points:</span>
                            <span id="victory-achievement-bonus">+0</span>
                        </div>
                    </div>
                </div>
                
                <div class="achievement-summary" id="victory-achievements">
                    <h3>Achievements Earned</h3>
                    <div class="achievement-icons" id="victory-achievement-icons">
                        <!-- Achievement icons will be populated here -->
                    </div>
                </div>
            </div>
            
            <div class="victory-actions">
                <button class="victory-btn victory-btn-primary" 
                        id="play-again-btn"
                        type="button"
                        accesskey="1"
                        aria-describedby="play-again-help">
                    üîÑ Play Again
                </button>
                <button class="victory-btn victory-btn-secondary" 
                        id="view-achievements-btn"
                        type="button"
                        accesskey="2"
                        aria-describedby="view-achievements-help">
                    üèÜ View All Achievements
                </button>
                <button class="victory-btn victory-btn-secondary" 
                        id="share-results-btn"
                        type="button"
                        accesskey="3"
                        aria-describedby="share-results-help">
                    üì§ Share Results
                </button>
                
                <!-- Hidden help text for screen readers -->
                <div class="sr-only">
                    <div id="play-again-help">Start a new game. Keyboard shortcut: Alt+1</div>
                    <div id="view-achievements-help">Open achievement gallery. Keyboard shortcut: Alt+2</div>
                    <div id="share-results-help">Share your results. Keyboard shortcut: Alt+3</div>
                </div>
            </div>
            
            <div class="victory-footer">
                <p>Thank you for playing LobeLabyrinth!</p>
                <p class="completion-grade" id="victory-grade">Excellent Performance!</p>
            </div>
        </div>
    </div>

    <!-- Keyboard Help Overlay (Hidden by default) -->
    <div id="keyboard-help-overlay" class="keyboard-help-overlay" style="display: none;">
        <div class="keyboard-help-content" role="dialog" aria-labelledby="keyboard-help-title" aria-modal="true">
            <h3 id="keyboard-help-title">‚å®Ô∏è Keyboard Shortcuts</h3>
            <div class="keyboard-help-text">
üéÆ GAME NAVIGATION
‚Ä¢ Arrow Keys: Navigate map
‚Ä¢ Enter: Select room/answer
‚Ä¢ Space: New question
‚Ä¢ Tab: Cycle through options
‚Ä¢ Shift+Tab: Reverse cycle

üéØ QUESTION ANSWERING
‚Ä¢ 1-4: Select answer A-D
‚Ä¢ Enter: Confirm selection
‚Ä¢ H: Show hint
‚Ä¢ S: Skip question
‚Ä¢ N: New question

üîß GAME CONTROLS
‚Ä¢ Ctrl+S: Quick save
‚Ä¢ Ctrl+L: Quick load
‚Ä¢ Ctrl+R: Reset game
‚Ä¢ A: View achievements
‚Ä¢ M: Toggle map focus

üìä INFORMATION
‚Ä¢ F1: Show help
‚Ä¢ F2: Quick stats
‚Ä¢ F5: Refresh room
‚Ä¢ ?: Show help

üèÜ VICTORY SCREEN
‚Ä¢ 1: Play again
‚Ä¢ 2: View achievements
‚Ä¢ 3: Share results
‚Ä¢ Escape: Close

üöÄ ADVANCED
‚Ä¢ Ctrl+Shift+R: Force reset
‚Ä¢ Ctrl+Shift+D: Debug mode
‚Ä¢ Ctrl+Shift+S: Export save

Press any key to close this help.
            </div>
        </div>
    </div>

    <!-- Game Completion Banner (Hidden by default) -->
    <div id="game-completion" class="game-completion" style="display: none;">
        <div class="game-completion-content" role="dialog" aria-labelledby="completion-title" aria-modal="true">
            <h3 id="completion-title">üèÜ Quest Complete!</h3>
            <p id="completion-message">You have successfully navigated the LobeLabyrinth!</p>
            <div class="completion-stats" id="completion-stats"></div>
            <div class="completion-actions">
                <button class="btn" id="completion-continue">Continue Exploring</button>
                <button class="btn btn-secondary" id="completion-achievements">View Achievements</button>
            </div>
        </div>
    </div>

    <!-- Load game modules -->
    <script src="src/dataLoader.js"></script>
    <script src="src/gameState.js"></script>
    <script src="src/quizEngine.js"></script>
    <script src="src/animationManager.js"></script>
    <script src="src/achievementManager.js"></script>
    <script src="src/mapRenderer.js"></script>
    <script src="src/uiManager.js"></script>
    <script src="src/errorBoundary.js"></script>
    <script src="src/accessibilityManager.js"></script>

    <script>
        // Global game instances
        let dataLoader;
        let gameState;
        let quizEngine;
        let animationManager;
        let achievementManager;
        let mapRenderer;
        let uiManager;
        let errorBoundary;
        let accessibilityManager;

        // Initialize the complete game
        async function initializeGame() {
            try {
                updateGameStatus('Initializing error boundary...');
                
                // Initialize error boundary first
                errorBoundary = new ErrorBoundary();
                
                updateGameStatus('Loading game data...');
                
                // Initialize core modules
                dataLoader = new DataLoader();
                await dataLoader.loadGameData();
                
                updateGameStatus('Initializing game state...');
                gameState = new GameState(dataLoader);
                
                // Initialize error boundary with game references
                errorBoundary.gameState = gameState;
                
                updateGameStatus('Setting up quiz engine...');
                quizEngine = new QuizEngine(dataLoader, gameState);
                
                // Initialize quiz engine question pool
                await quizEngine.initializeQuestionPool();
                
                updateGameStatus('Initializing animations...');
                animationManager = new AnimationManager({
                    defaultDuration: 800,
                    easing: 'ease-out'
                });
                
                updateGameStatus('Setting up achievement system...');
                achievementManager = new AchievementManager(dataLoader, gameState);
                await achievementManager.initialize();
                
                updateGameStatus('Creating user interface...');
                uiManager = new UIManager(dataLoader, gameState, quizEngine, animationManager, achievementManager);
                
                updateGameStatus('Initializing castle map...');
                const mapCanvas = document.getElementById('map-canvas');
                mapRenderer = new MapRenderer(mapCanvas, gameState, dataLoader);
                
                // Initial map render
                await mapRenderer.render();
                
                updateGameStatus('Initializing accessibility features...');
                accessibilityManager = new AccessibilityManager();
                
                // Connect accessibility manager to game components
                accessibilityManager.gameState = gameState;
                accessibilityManager.uiManager = uiManager;
                
                // Setup accessibility event listeners
                setupAccessibilityIntegration();
                
                // Connect error boundary to UI manager for better error handling
                errorBoundary.uiManager = uiManager;
                
                // Try to load saved game
                if (gameState.loadGame()) {
                    updateGameStatus('Saved game loaded successfully!');
                } else {
                    updateGameStatus('New game started. Welcome to LobeLabyrinth!');
                }

                // Auto-save every 30 seconds
                setInterval(() => {
                    gameState.saveGame();
                }, 30000);

                console.log('LobeLabyrinth game initialized successfully!');

            } catch (error) {
                console.error('Failed to initialize game:', error);
                updateGameStatus(`Failed to initialize game: ${error.message}`);
            }
        }

        function updateGameStatus(message) {
            const statusElement = document.getElementById('game-status-footer');
            if (statusElement) {
                statusElement.innerHTML = message;
            }
        }

        // Setup accessibility integration with game components
        function setupAccessibilityIntegration() {
            // Verify all components are initialized before setting up event listeners
            if (!accessibilityManager) {
                console.warn('AccessibilityManager not initialized, skipping integration');
                return;
            }

            // Listen for map navigation accessibility events
            document.addEventListener('accessibility-map-navigate', (event) => {
                const direction = event.detail.direction;
                // Integrate with map renderer for keyboard navigation
                if (mapRenderer && mapRenderer.navigateWithKeyboard) {
                    mapRenderer.navigateWithKeyboard(direction);
                }
            });

            // Listen for game state changes to announce them
            if (gameState && gameState.on && typeof gameState.on === 'function') {
                gameState.on('roomChanged', (roomData) => {
                    if (accessibilityManager && accessibilityManager.announceGameState) {
                        accessibilityManager.announceGameState({
                            roomChanged: true,
                            currentRoom: roomData
                        });
                    }
                });

                gameState.on('scoreChanged', (scoreData) => {
                    if (accessibilityManager && accessibilityManager.announceGameState) {
                        accessibilityManager.announceGameState({
                            scoreChanged: true,
                            score: scoreData.score
                        });
                    }
                });
            }

            // Listen for quiz events
            if (quizEngine && quizEngine.on && typeof quizEngine.on === 'function') {
                quizEngine.on('questionPresented', (questionData) => {
                    if (accessibilityManager && accessibilityManager.announceGameState) {
                        accessibilityManager.announceGameState({
                            questionChanged: true,
                            question: questionData
                        });
                    }
                });

                quizEngine.on('answerValidated', (result) => {
                    if (accessibilityManager && accessibilityManager.announceAnswerResult) {
                        accessibilityManager.announceAnswerResult(
                            result.isCorrect, 
                            result.explanation
                        );
                    }
                });
            }

            // Enhance UI manager with accessibility hooks
            if (uiManager && uiManager.addAccessibilityHooks) {
                uiManager.addAccessibilityHooks(accessibilityManager);
            }

            console.log('‚ôø Accessibility integration setup complete');

            // Setup enhanced keyboard navigation for new UI elements
            setupEnhancedKeyboardHandlers();
        }

        // Setup enhanced keyboard handlers for new UI elements
        function setupEnhancedKeyboardHandlers() {
            // Keyboard help overlay handlers
            const keyboardOverlay = document.getElementById('keyboard-help-overlay');
            if (keyboardOverlay) {
                // Close on click outside content
                keyboardOverlay.addEventListener('click', (event) => {
                    if (event.target === keyboardOverlay) {
                        keyboardOverlay.style.display = 'none';
                    }
                });

                // Close on any key press when overlay is open
                keyboardOverlay.addEventListener('keydown', (event) => {
                    keyboardOverlay.style.display = 'none';
                    event.stopPropagation();
                });
            }

            // Game completion banner handlers
            const gameCompletion = document.getElementById('game-completion');
            const completionContinue = document.getElementById('completion-continue');
            const completionAchievements = document.getElementById('completion-achievements');

            if (completionContinue) {
                completionContinue.addEventListener('click', () => {
                    if (gameCompletion) gameCompletion.style.display = 'none';
                });
            }

            if (completionAchievements) {
                completionAchievements.addEventListener('click', () => {
                    if (uiManager && uiManager.toggleAchievementGallery) {
                        uiManager.toggleAchievementGallery();
                    }
                });
            }

            // Achievement gallery close button
            const achievementClose = document.getElementById('achievement-gallery-close');
            if (achievementClose) {
                achievementClose.addEventListener('click', () => {
                    const gallery = document.getElementById('achievement-gallery');
                    if (gallery) {
                        gallery.style.display = 'none';
                        gallery.classList.remove('visible');
                        // Update button state
                        const toggle = document.getElementById('achievement-toggle');
                        if (toggle) toggle.setAttribute('aria-expanded', 'false');
                    }
                });
            }

            // Global keyboard shortcuts
            document.addEventListener('keydown', (event) => {
                // Don't interfere if user is typing in an input field
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                    return;
                }

                // F1 key for help
                if (event.key === 'F1') {
                    event.preventDefault();
                    const helpOverlay = document.getElementById('keyboard-help-overlay');
                    if (helpOverlay) {
                        helpOverlay.style.display = 'flex';
                        // Focus the help content for screen readers
                        const helpContent = helpOverlay.querySelector('.keyboard-help-content');
                        if (helpContent) helpContent.focus();
                    }
                }

                // Escape key for closing overlays
                if (event.key === 'Escape') {
                    let handled = false;
                    
                    const helpOverlay = document.getElementById('keyboard-help-overlay');
                    const gameCompletion = document.getElementById('game-completion');
                    const achievementGallery = document.getElementById('achievement-gallery');

                    if (helpOverlay && helpOverlay.style.display === 'flex') {
                        helpOverlay.style.display = 'none';
                        handled = true;
                    } else if (gameCompletion && gameCompletion.style.display !== 'none') {
                        gameCompletion.style.display = 'none';
                        handled = true;
                    } else if (achievementGallery && (achievementGallery.classList.contains('visible') || achievementGallery.style.display !== 'none')) {
                        achievementGallery.style.display = 'none';
                        achievementGallery.classList.remove('visible');
                        // Update button state
                        const toggle = document.getElementById('achievement-toggle');
                        if (toggle) toggle.setAttribute('aria-expanded', 'false');
                        handled = true;
                    }

                    if (handled) event.preventDefault();
                }

                // Quick shortcuts for achievement gallery
                if ((event.altKey || event.ctrlKey) && event.key.toLowerCase() === 'a') {
                    event.preventDefault();
                    const achievementToggle = document.getElementById('achievement-toggle');
                    if (achievementToggle) achievementToggle.click();
                }
            });

            console.log('‚å®Ô∏è Enhanced keyboard handlers setup complete');
        }

        // Expose game instances globally for debugging
        window.gameData = {
            dataLoader: () => dataLoader,
            gameState: () => gameState,
            quizEngine: () => quizEngine,
            animationManager: () => animationManager,
            achievementManager: () => achievementManager,
            mapRenderer: () => mapRenderer,
            uiManager: () => uiManager,
            errorBoundary: () => errorBoundary,
            accessibilityManager: () => accessibilityManager
        };

        // Initialize game when page loads
        document.addEventListener('DOMContentLoaded', initializeGame);

        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('üöÄ PWA: Service Worker registered successfully', registration.scope);
                    
                    // Handle service worker updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (newWorker) {
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Show update notification
                                    if (uiManager) {
                                        uiManager.showTooltip('üîÑ New version available! Refresh to update.', 5000);
                                    }
                                }
                            });
                        }
                    });
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è PWA: Service Worker registration failed:', error);
                }
            });
        }

        // Handle page unload to save game
        window.addEventListener('beforeunload', () => {
            if (gameState) {
                gameState.saveGame();
            }
        });
    </script>
</body>
</html>